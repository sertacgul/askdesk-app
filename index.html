<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AskDesk | askdesk.app</title>
    
    <!-- UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Data Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',      
                            panel: '#1e293b',     
                            primary: '#6366f1',
                            accent: '#f43f5e',
                            success: '#10b981',
                            warning: '#f59e0b',
                            info: '#3b82f6',
                            pro: '#22c55e',       
                            enterprise: '#a855f7' 
                        }
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <style>
        /* SCROLL BAR FIX: Enable native scrolling */
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            transition: all 0.3s; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            overflow-y: auto; /* Enable vertical scroll on body */
        }
        
        .glass-input { 
            background: #1e293b; 
            border: 1px solid #334155; 
            color: white; 
            transition: all 0.2s;
        }
        .glass-input:focus { 
            border-color: #6366f1; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); 
            outline: none; 
        }
        option { background-color: #1e293b; color: white; padding: 5px; }
        select { cursor: pointer; }
        
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; border: 2px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .loader {
            border: 3px solid #1e293b;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        html[dir="rtl"] .fa-chevron-right { transform: rotate(180deg); }
        html[dir="rtl"] .text-right { text-align: left; } 
        html[dir="rtl"] .text-left { text-align: right; }

        /* Copy Guard Class */
        .protected-text {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
    
    <!-- PWA Manifest & Service Worker -->
    <link rel="manifest" href="manifest.json">
    <script>
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('sw.js')
                .then(reg => console.log('Service Worker registered'))
                .catch(err => console.log('Service Worker failed', err));
        });
    }
    </script>
</head>
<body class="text-slate-200">

    <!-- HEADER -->
    <header class="bg-brand-panel border-b border-slate-700 h-auto min-h-[4rem] py-2 flex flex-wrap items-center justify-between px-4 md:px-6 shadow-lg z-20 shrink-0 gap-2 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="relative w-8 h-8 md:w-10 md:h-10 group cursor-pointer">
                <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full drop-shadow-lg transform transition group-hover:scale-105 duration-300">
                    <rect width="40" height="40" rx="10" fill="url(#brand_gradient)"/>
                    <path d="M20 8C13.3726 8 8 13.3726 8 20C8 26.6274 13.3726 32 20 32C26.6274 32 32 26.6274 32 20C32 13.3726 26.6274 8 20 8ZM20 10.4C25.3019 10.4 29.6 14.6981 29.6 20C29.6 25.3019 25.3019 29.6 20 29.6C14.6981 29.6 10.4 25.3019 10.4 20C10.4 14.6981 14.6981 10.4 20 10.4Z" fill="white" fill-opacity="0.1"/>
                    <path d="M20 6V12M20 28V34M6 20H12M28 20H34" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="5" stroke="white" stroke-width="2"/>
                    <circle cx="20" cy="20" r="2" fill="#F43F5E"/>
                    <defs>
                        <linearGradient id="brand_gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#6366F1"/>
                            <stop offset="1" stop-color="#8B5CF6"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div>
                <h1 class="text-lg md:text-xl font-bold text-white tracking-wide">AskDesk</h1>
                <p class="text-[9px] md:text-[10px] text-slate-400 font-mono tracking-wider">Generated with responsibility by ATAOL AI Techs</p>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-2 ml-auto">
            <!-- Usage Badge -->
            <div id="usageBadge" class="h-8 px-3 rounded bg-slate-800 border border-slate-600 flex items-center justify-center text-[10px] text-slate-400 font-mono min-w-[3rem]">0/5</div>
            
            <!-- Plan Badge -->
            <button id="planBadge" class="h-8 px-3 text-[10px] font-bold rounded bg-slate-700 text-slate-300 uppercase tracking-wide border border-slate-600 transition-colors cursor-pointer flex items-center justify-center min-w-[4rem]" onclick="App.billing.cyclePlan()">Starter</button>
            
            <!-- Lang Select -->
            <select id="uiLangSelect" onchange="App.ui.changeLanguage(this.value)" class="h-8 bg-slate-800 border border-slate-600 text-xs rounded px-2 text-slate-300 outline-none focus:border-brand-primary cursor-pointer w-auto min-w-[4rem]"></select>
            
             <!-- Settings Trigger -->
             <button onclick="App.ui.toggleSettings()" class="h-8 w-8 rounded bg-slate-800 border border-slate-600 flex items-center justify-center text-slate-400 hover:text-white transition" title="User Settings"><i class="fa-solid fa-user-gear"></i></button>
        </div>
    </header>

    <!-- SETTINGS PANEL (User Email & Magic Link) -->
    <div id="settingsPanel" class="hidden absolute top-16 right-4 w-80 md:w-96 bg-slate-800 border border-slate-600 shadow-2xl z-50 p-4 rounded-xl">
        <h3 class="text-sm font-bold text-white mb-2 flex items-center gap-2">
            <i class="fa-solid fa-user-shield text-brand-primary"></i> <span data-i18n="settingsTitle">User Account</span>
        </h3>
        <p class="text-[10px] text-slate-400 mb-3 leading-relaxed">
            Enter your email to sync your plan and limits. We will send a <b>Magic Link</b> to login.
        </p>
        <input type="email" id="userEmailInput" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs font-mono mb-3 focus:border-brand-primary outline-none" placeholder="user@example.com">
        
        <!-- Hidden API URL Input -->
        <input type="hidden" id="apiUrlInput">

        <div class="flex justify-end gap-2">
            <button onclick="App.ui.toggleSettings()" class="text-slate-400 hover:text-white text-xs px-3 py-1" data-i18n="cancel">Close</button>
            <button onclick="App.billing.saveUserEmail()" class="bg-brand-primary hover:bg-indigo-500 text-white px-4 py-1.5 rounded text-xs font-bold transition" data-i18n="save">Send Magic Link</button>
        </div>
    </div>

    <!-- MAIN -->
    <div class="flex flex-col md:flex-row min-h-[calc(100vh-4rem)]">
        
        <!-- LEFT: INPUTS -->
        <div class="w-full md:w-[40%] flex flex-col bg-slate-900 border-b md:border-b-0 md:border-r border-slate-700 relative">
            
            <!-- Scrollable Content Area -->
            <div class="flex-1 p-4 flex flex-col gap-3 overflow-y-auto">
                <!-- Config -->
                <div class="bg-brand-panel p-3 rounded-xl border border-slate-700 shadow-sm space-y-2 shrink-0">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-1">
                        <h3 class="text-xs font-bold text-brand-primary uppercase flex items-center gap-2">
                            <i class="fa-solid fa-sliders"></i> <span data-i18n="configTitle">Configuration</span>
                        </h3>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-0.5 uppercase font-bold" data-i18n="domainLabel">Domain</label>
                        <select id="domainSelect" class="glass-input w-full rounded px-2 py-1.5 text-xs cursor-pointer"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-0.5 uppercase font-bold" data-i18n="qLangLabel">Question Lang</label>
                            <select id="qLangSelect" class="glass-input w-full rounded px-2 py-1.5 text-xs cursor-pointer"></select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-0.5 uppercase font-bold" data-i18n="aLangLabel">Answer Lang</label>
                            <select id="aLangSelect" class="glass-input w-full rounded px-2 py-1.5 text-xs cursor-pointer"></select>
                        </div>
                    </div>
                </div>

                <!-- Metadata -->
                <div class="bg-brand-panel p-3 rounded-xl border border-slate-700 shadow-sm hidden md:block shrink-0">
                    <h3 class="text-xs font-bold text-brand-primary uppercase mb-1 flex items-center gap-2">
                        <i class="fa-solid fa-tag"></i> <span data-i18n="metaTitle">Document Info</span>
                    </h3>
                    <div class="grid grid-cols-3 gap-2">
                        <div class="col-span-2">
                            <label class="block text-[10px] text-slate-400 mb-0.5 uppercase" data-i18n="docNameLabel">Document Name</label>
                            <input type="text" id="docName" class="glass-input w-full rounded px-2 py-1 text-xs font-medium" placeholder="FCOM">
                        </div>
                        <div class="col-span-1">
                            <label class="block text-[10px] text-slate-400 mb-0.5 uppercase" data-i18n="pageNumLabel">Page</label>
                            <input type="text" id="pageNum" class="glass-input w-full rounded px-2 py-1 text-xs font-medium text-center" placeholder="123">
                        </div>
                    </div>
                </div>

                <!-- Source Input -->
                <div class="flex-1 flex flex-col min-h-[500px]"> 
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-[10px] font-bold text-slate-300 uppercase flex items-center gap-1 shrink-0">
                            <i class="fa-solid fa-align-left text-brand-primary"></i> <span data-i18n="sourceTextLabel">Source</span>
                        </label>
                        
                        <div class="flex gap-4 ml-3 items-center">
                            <div class="text-[9px] text-slate-500 font-mono">
                                Density: <span id="densityScore" class="text-slate-400">0</span> Q/Doc
                            </div>
                            <span id="charCount" class="text-[9px] text-slate-500">0 chars</span>
                        </div>
                        
                        <div class="flex-1"></div>

                        <input type="file" id="fileUpload" class="hidden" accept=".txt,.md,.csv,.json,.xml,.png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx" onchange="App.ui.handleFileUpload(this)">
                        
                        <button onclick="document.getElementById('fileUpload').click()" 
                            class="bg-slate-700 hover:bg-slate-600 text-brand-primary hover:text-white border border-slate-600 font-bold py-1 px-3 rounded shadow-md transition flex items-center gap-1 text-[10px] h-6 cursor-pointer">
                            <i class="fa-solid fa-cloud-arrow-up text-sm"></i> 
                            <span data-i18n="uploadBtn">UPLOAD</span>
                        </button>
                        
                        <button onclick="App.ui.clearInput()" class="bg-slate-800 hover:bg-red-900/30 text-slate-400 hover:text-red-400 border border-slate-700 font-bold py-1 px-3 rounded shadow-md transition flex items-center gap-1 text-[10px] h-6 cursor-pointer">
                            <i class="fa-solid fa-eraser"></i>
                            <span data-i18n="clear">CLEAR</span>
                        </button>
                    </div>

                    <div class="relative w-full flex-1">
                        <textarea id="sourceText" oninput="App.ui.handleTextChange()"
                            class="glass-input w-full h-[500px] rounded-xl p-3 text-xs font-mono leading-relaxed resize-none focus:ring-brand-primary whitespace-pre-wrap"
                            placeholder="Paste text here... (Long text enables Multi-Q option)"
                            data-i18n-placeholder="sourcePlaceholder"></textarea>
                        
                        <div id="imagePreviewContainer" class="hidden absolute inset-0 bg-slate-900/90 rounded-xl flex-col items-center justify-center border-2 border-dashed border-brand-primary z-10 p-4">
                            <img id="previewImgElement" class="max-h-[80%] max-w-full rounded shadow-lg object-contain mb-2" />
                            <div class="flex gap-2">
                                <span class="text-xs text-brand-primary bg-brand-primary/10 px-2 py-1 rounded">Image Mode Active</span>
                                <button onclick="App.ui.clearInput()" class="text-xs text-red-400 hover:text-white px-2 py-1 bg-red-900/20 rounded">Remove</button>
                            </div>
                        </div>

                        <div id="fileLoader" class="hidden absolute inset-0 bg-slate-900/80 z-20 flex-col items-center justify-center rounded-xl backdrop-blur-sm">
                            <div class="loader mb-2"></div>
                            <span class="text-xs text-brand-primary font-bold">Processing File...</span>
                        </div>
                    </div>
                </div>

                <!-- Bulk Panel -->
                <div id="bulkPanel" class="hidden bg-slate-800/50 border border-slate-700 rounded-xl p-2 mb-1 animate-in fade-in slide-in-from-bottom-4 shrink-0">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[10px] font-bold text-brand-warning flex items-center gap-1">
                            <i class="fa-solid fa-layer-group"></i> Bulk Mode
                        </span>
                        <span id="bulkLimitLabel" class="text-[9px] text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-600">Max: 5</span>
                    </div>
                    
                    <div class="flex items-center gap-2 mb-1">
                        <input type="range" id="bulkRange" min="1" max="5" value="1" class="flex-1 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer" oninput="App.ui.updateBulkLabel(this.value)">
                        <span id="bulkValue" class="text-xs font-bold text-white w-6 text-center bg-brand-primary rounded px-0.5">1</span>
                    </div>
                    
                    <div id="bulkProgressContainer" class="hidden w-full bg-slate-700 rounded-full h-1.5 mb-1">
                        <div id="bulkProgressBar" class="bg-brand-success h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="bulkStatusText" class="hidden text-[9px] text-center text-slate-400 mb-1">Generating 0/0...</div>
                </div>
            </div>

            <!-- Sticky Generate Button (Fixed Bottom) -->
            <div class="p-4 bg-slate-900 border-t border-slate-800 sticky bottom-0 z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
                <div id="errorBox" class="hidden mb-2 p-3 bg-red-900/40 border border-red-800 rounded text-red-200 text-xs flex flex-col gap-1 w-full relative">
                    <div class="flex items-center justify-between font-bold">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> <span>Error</span></div>
                        <button onclick="document.getElementById('errorBox').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <span id="errorMsg">Details...</span>
                </div>
                
                <button id="analyzeBtn" onclick="App.logic.startGeneration()" class="w-full bg-brand-primary hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex justify-center items-center gap-2 group cursor-pointer relative overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btnText" class="text-sm md:text-base" data-i18n="analyzeBtn">Generate Q&A</span>
                    <i id="btnIcon" class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition-transform"></i>
                    <div id="btnLoader" class="loader hidden border-white/20 border-t-white"></div>
                    <div id="stopBtnOverlay" class="hidden absolute inset-0 bg-red-600 hover:bg-red-700 flex items-center justify-center gap-2 cursor-pointer" onclick="event.stopPropagation(); App.logic.stopBulk();">
                        <i class="fa-solid fa-stop"></i> STOP
                    </div>
                </button>
            </div>
        </div>

        <!-- RIGHT: OUTPUT -->
        <div class="w-full md:w-[60%] flex flex-col bg-[#0f172a]">
            <!-- Preview -->
            <div class="h-[40%] bg-slate-900/50 p-4 md:p-6 border-b border-slate-700 overflow-y-auto relative">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xs md:text-sm font-bold text-brand-primary uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check"></i> <span data-i18n="previewTitle">AI Output Preview</span>
                        <a href="https://api.askdesk.app/billing/upgrade?plan=pro" target="_blank" id="previewUpgradeBtn" class="hidden ml-2 text-[9px] bg-brand-pro text-white px-2 py-0.5 rounded hover:bg-green-600 transition">UPGRADE</a>
                    </h2>
                    <span id="statusTag" class="text-[9px] bg-slate-800 text-slate-500 px-2 py-1 rounded border border-slate-700" data-i18n="statusReady">Ready</span>
                </div>

                <div id="qualityBox" class="hidden mb-3 p-2 bg-slate-800/50 rounded-lg border border-slate-700 text-xs">
                    <div class="flex items-center justify-between mb-1">
                        <div class="flex items-center gap-2">
                            <span class="font-bold uppercase text-slate-400 text-[10px]" data-i18n="qualityScore">Quality Score</span>
                            <span id="qScoreBadge" class="px-1.5 py-0.5 rounded text-white font-bold text-[10px]">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold uppercase text-slate-400 text-[10px]" data-i18n="groundingStatus">Grounding</span>
                            <span id="groundingBadge" class="px-1.5 py-0.5 rounded text-white font-bold text-[10px]">-</span>
                        </div>
                    </div>
                    <ul id="qReasons" class="list-disc list-inside text-slate-400 mb-1 italic text-[10px]"></ul>
                    <details class="group">
                        <summary class="cursor-pointer text-brand-info hover:text-white font-semibold select-none flex items-center gap-1 text-[10px]">
                            <i class="fa-solid fa-chevron-right text-[9px] group-open:rotate-90 transition"></i>
                            <span data-i18n="viewExtract">View Source Extract</span>
                        </summary>
                        <div class="mt-1 p-2 bg-slate-900 rounded border border-slate-700 font-mono text-[9px] text-slate-300 whitespace-pre-wrap" id="extractPreview"></div>
                    </details>
                </div>

                <div class="space-y-3 pb-8">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-0.5" data-i18n="generatedQ">Question</label>
                        <!-- Protected Textarea (COPY GUARD) -->
                        <textarea id="questionOutput" class="glass-input w-full rounded-lg p-3 text-white text-xs md:text-sm font-bold h-14 md:h-16 protected-text" readonly></textarea>
                    </div>
                    <div class="h-32 md:h-40 flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-0.5" data-i18n="generatedA">Answer</label>
                        <!-- Protected Textarea (COPY GUARD) -->
                        <textarea id="answerOutput" class="glass-input w-full flex-1 rounded-lg p-3 text-slate-300 text-xs md:text-sm font-mono whitespace-pre protected-text" readonly></textarea>
                    </div>
                    <div class="flex justify-end gap-2 pt-1">
                        <button id="regenerateBtn" onclick="App.logic.regenerate()" disabled class="text-[10px] md:text-xs text-brand-primary hover:text-white font-bold px-3 py-1.5 border border-brand-primary/50 hover:border-brand-primary rounded-lg transition flex items-center gap-2 opacity-50 cursor-not-allowed">
                            <i class="fa-solid fa-rotate"></i> <span data-i18n="regenerateBtn">Regenerate</span>
                        </button>
                        <button id="addToLogBtn" onclick="App.logic.addToLog()" disabled class="bg-slate-800 text-slate-500 font-semibold px-4 py-1.5 rounded-lg border border-slate-700 transition cursor-not-allowed flex items-center gap-2 text-[10px] md:text-xs">
                            <i class="fa-solid fa-circle-plus"></i> <span data-i18n="addBtn">Add to Log</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Table -->
            <div class="flex-1 flex flex-col bg-[#0f172a] overflow-hidden">
                <div class="bg-slate-900 border-b border-slate-800 px-4 py-2 shadow-md z-10 shrink-0 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-300"><span data-i18n="logTitle">Session Log</span> (<span id="counterDisplay">0</span>)</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <div class="flex bg-slate-800 rounded-lg p-0.5 border border-slate-700">
                                <button id="btnExportExcel" onclick="App.exporters.toExcel()" class="px-2 py-1 text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition hidden" title="Export Excel" data-export="excel"><i class="fa-solid fa-file-excel text-green-500 mr-1"></i> XLSX</button>
                                <div class="w-px bg-slate-700 my-1"></div>
                                <button id="btnExportCSV" onclick="App.exporters.toCSV()" class="px-2 py-1 text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition hidden" title="Export CSV" data-export="csv"><i class="fa-solid fa-file-csv text-blue-500 mr-1"></i> CSV</button>
                                <div class="w-px bg-slate-700 my-1"></div>
                                <button id="btnExportJSON" onclick="App.exporters.toJSON()" class="px-2 py-1 text-[9px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition hidden" title="Export JSON" data-export="json"><i class="fa-solid fa-code text-yellow-500 mr-1"></i> JSON</button>
                            </div>
                            <button onclick="App.logic.clearLog()" class="text-xs text-red-400 hover:text-red-300 ml-2" title="Clear All"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="flex gap-1 items-center pb-1 overflow-x-auto no-scrollbar">
                        <select id="filterDomain" onchange="App.logic.renderTable()" class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-1 py-0.5 outline-none focus:border-brand-primary cursor-pointer min-w-[80px]">
                            <option value="all" data-i18n="allDomains">All Domains</option>
                        </select>
                        <select id="filterStatus" onchange="App.logic.renderTable()" class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-1 py-0.5 outline-none focus:border-brand-primary cursor-pointer min-w-[80px]">
                            <option value="all" data-i18n="allStatuses">All Statuses</option>
                            <option value="Draft">Draft</option>
                            <option value="Reviewed">Reviewed</option>
                            <option value="Approved">Approved</option>
                        </select>
                        <input type="text" id="filterSearch" oninput="App.logic.renderTable()" placeholder="Search..." class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-0.5 w-full md:w-32 outline-none focus:border-brand-primary placeholder:text-slate-600">
                    </div>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-800 text-xs uppercase sticky top-0 z-10 shadow-sm text-slate-400">
                            <tr>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-12">#</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-24" data-i18n="thDoc">Doc</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700" data-i18n="thContent">Q & A</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-28" data-i18n="thMeta">Meta</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="text-sm divide-y divide-slate-800/50">
                            <!-- Rows injected here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-xl p-4 w-96 shadow-2xl">
            <h3 class="text-sm font-bold text-white mb-2" data-i18n="reviewerNotes">Reviewer Notes</h3>
            <textarea id="notesInput" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white h-24 mb-3 resize-none focus:border-brand-primary outline-none"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('notesModal').classList.add('hidden')" class="text-slate-400 text-xs hover:text-white px-3 py-1" data-i18n="cancel">Cancel</button>
                <button onclick="App.logic.saveNotes()" class="bg-brand-primary text-white text-xs px-4 py-1 rounded hover:bg-indigo-500" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-brand-success text-white px-4 py-3 rounded-lg shadow-2xl transform translate-y-24 transition duration-300 flex items-center gap-3 z-50 border border-green-400">
        <i class="fa-solid fa-check-circle text-lg"></i>
        <div>
            <h4 class="font-bold text-sm" data-i18n="success">Success</h4>
            <p class="text-xs text-green-100" id="toastMsg">Action completed.</p>
        </div>
        <!-- FIXED: Re-added upgrade button for toast -->
        <a id="toastActionBtn" href="https://api.askdesk.app/billing/upgrade" target="_blank" class="hidden ml-2 bg-white text-brand-success text-xs font-bold px-2 py-1 rounded hover:bg-gray-100 uppercase">UPGRADE</a>
    </div>

    <!-- APP LOGIC -->
    <script>
    const App = {
        api: { 
            // Changed to production API
            primary: "https://api.askdesk.app",
            current: "https://api.askdesk.app" 
        },

        config: {
            languages: [
                {code: 'en', label: 'English'}, {code: 'tr', label: 'TÃ¼rkÃ§e'}, {code: 'de', label: 'Deutsch'},
                {code: 'fr', label: 'FranÃ§ais'}, {code: 'es', label: 'EspaÃ±ol'}, {code: 'pt-BR', label: 'PortuguÃªs'},
                {code: 'ja', label: 'æ—¥æœ¬èªž'}, {code: 'zh', label: 'ç®€ä½“ä¸­æ–‡'}, {code: 'ko', label: 'í•œêµ­ì–´'},
                {code: 'pl', label: 'Polski'}, {code: 'nl', label: 'Nederlands'}, {code: 'hi', label: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€'},
                {code: 'ru', label: 'Ð ÑƒÑÑÐºÐ¸Ð¹'}, {code: 'ar', label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', dir: 'rtl'}
            ],
            domains: [
                {id: 'general', label: 'General'},
                {id: 'aviation', label: 'Aviation'},
                {id: 'strategy', label: 'Strategy'},
                {id: 'legal', label: 'Legal'},
                {id: 'medical', label: 'Medical'},
                {id: 'compliance', label: 'Compliance / ISO'}
            ],
            // PLAN LOGIC - DEFINED AS REQUESTED
            plans: {
                'starter': { dailyLimit: 5, maxBulk: 5, label: 'Starter', canExport: [], canCopy: false },
                'pro': { dailyLimit: 100, maxBulk: 20, label: 'Pro', canExport: ['excel', 'csv'], canCopy: false },
                'enterprise': { dailyLimit: Infinity, maxBulk: 100, label: 'Enterprise', canExport: ['excel', 'csv', 'json'], canCopy: true }
            },
            UPGRADE_URL: "https://api.askdesk.app/billing/upgrade"
        },

        data: {
            qaLog: [],
            previewState: null,
            editingNoteId: null,
            currentImage: null,
            abortController: null, 
            bulkActive: false
        },

        // --- STORAGE ---
        storage: {
            getPrefs: () => JSON.parse(localStorage.getItem('askdesk_prefs') || '{"uiLang":"en","domain":"general"}'),
            savePrefs: (p) => localStorage.setItem('askdesk_prefs', JSON.stringify({...App.storage.getPrefs(), ...p})),
            saveApiUrl: () => {
                const url = document.getElementById('apiUrlInput').value.trim();
                if(url) { 
                    localStorage.setItem('askdesk_api_base', url); 
                    App.api.current = url;
                    App.ui.toggleSettings();
                    App.ui.showToast("API URL Updated");
                }
            }
        },

        // --- I18N MODULE ---
        i18n: {
            currentLang: 'en',
            translations: {
                en: {
                    bannerWarning: "ðŸ”’ Secure Mode: API Key is managed server-side. Do not paste PII.",
                    appSubtitle: "PROD SERVER EDITION",
                    settingsTitle: "API Configuration", settingsDesc: "Enter backend URL (e.g. https://my-worker.dev)",
                    configTitle: "Configuration", domainLabel: "Domain", qLangLabel: "Question Lang", aLangLabel: "Answer Lang",
                    metaTitle: "Document Info", docNameLabel: "Doc Name", pageNumLabel: "Page Ref",
                    sourceTextLabel: "Source Content", clear: "Clear", error: "Error",
                    analyzeBtn: "Generate Q&A", previewTitle: "AI Output Preview", statusReady: "Ready",
                    generatedQ: "Question", generatedA: "Answer", addBtn: "Add to Log", regenerateBtn: "Regenerate",
                    logTitle: "Session Log", thDoc: "Doc", thContent: "Q & A", thMeta: "Meta",
                    noData: "No entries yet.", success: "Success", analyzing: "Analyzing...",
                    minCharsErr: "Please provide text or an image.",
                    notFound: "Not found in provided text",
                    uploadBtn: "UPLOAD FILE", uploadError: "File format not supported.",
                    qualityScore: "Quality Score", groundingStatus: "Grounding",
                    viewExtract: "View Source Extract", reviewerNotes: "Reviewer Notes",
                    allDomains: "All Domains", allStatuses: "All Statuses",
                    statusDraft: "Draft", statusReviewed: "Reviewed", statusApproved: "Approved",
                    cancel: "Cancel", save: "Save",
                    limitReached: "Limit reached â€“ Upgrade to Pro",
                    upgradeBtn: "Upgrade to Pro",
                    copyRestricted: "This content is protected. Upgrade to export."
                },
                tr: {
                    bannerWarning: "ðŸ”’ GÃ¼venli Mod: API AnahtarÄ± sunucuda yÃ¶netilir. Gizli veri girmeyin.",
                    appSubtitle: "PROD SUNUCU SÃœRÃœMÃœ",
                    settingsTitle: "API AyarlarÄ±", settingsDesc: "Backend URL giriniz (Ã¶rn. https://my-worker.dev)",
                    configTitle: "YapÄ±landÄ±rma", domainLabel: "Alan", qLangLabel: "Soru Dili", aLangLabel: "Cevap Dili",
                    metaTitle: "DokÃ¼man", docNameLabel: "DokÃ¼man AdÄ±", pageNumLabel: "Sayfa",
                    sourceTextLabel: "Kaynak Ä°Ã§erik", clear: "Temizle", error: "Hata",
                    analyzeBtn: "OluÅŸtur", previewTitle: "Ã–nizleme", statusReady: "HazÄ±r",
                    generatedQ: "Soru", generatedA: "Cevap", addBtn: "Listeye Ekle", regenerateBtn: "Yeniden Ãœret",
                    logTitle: "KayÄ±tlar", thDoc: "DokÃ¼man", thContent: "Ä°Ã§erik", thMeta: "Detay",
                    noData: "Veri yok.", success: "BaÅŸarÄ±lÄ±", analyzing: "Ä°ÅŸleniyor...",
                    minCharsErr: "LÃ¼tfen metin girin veya gÃ¶rsel yÃ¼kleyin.",
                    notFound: "Metinde bulunamadÄ±",
                    uploadBtn: "DOSYA YÃœKLE", uploadError: "Format desteklenmiyor.",
                    qualityScore: "Kalite PuanÄ±", groundingStatus: "Dayanak",
                    viewExtract: "AlÄ±ntÄ±yÄ± GÃ¶ster", reviewerNotes: "Ä°nceleme NotlarÄ±",
                    allDomains: "TÃ¼m Alanlar", allStatuses: "TÃ¼m Durumlar",
                    statusDraft: "Taslak", statusReviewed: "Ä°ncelendi", statusApproved: "OnaylandÄ±",
                    cancel: "Ä°ptal", save: "Kaydet",
                    limitReached: "Limit doldu â€“ Pro'ya GeÃ§",
                    upgradeBtn: "Pro'ya YÃ¼kselt",
                    copyRestricted: "Bu iÃ§erik korunuyor. Export Ã¶zelliÄŸini kullanÄ±n."
                }
            },
            
            t(key) {
                const lang = this.currentLang;
                const dict = this.translations[lang] || this.translations['en'];
                return dict[key] || this.translations['en'][key] || key;
            },

            updateUI() {
                document.querySelectorAll('[data-i18n]').forEach(el => {
                    el.innerText = this.t(el.getAttribute('data-i18n'));
                });
                const langObj = App.config.languages.find(l => l.code === this.currentLang);
                document.documentElement.dir = (langObj && langObj.dir === 'rtl') ? 'rtl' : 'ltr';
            }
        },

        // --- BILLING MODULE ---
        billing: {
            init() {
                const savedPlan = localStorage.getItem('askdesk_plan') || 'starter'; 
                this.updateUI();
                this.setupCopyGuard();
            },
            
            // NEW: Magic Link Request
            async saveUserEmail() {
                const email = document.getElementById('userEmailInput').value.trim();
                if(!email) return;
                
                App.ui.setLoading(true);
                try {
                    localStorage.setItem('askdesk_user_email', email);
                    
                    // Request Backend to send email
                    const res = await fetch(App.api.current + '/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email })
                    });
                    
                    if (res.ok) {
                        App.ui.showToast(`Magic Link sent to ${email}`);
                        App.ui.toggleSettings();
                    } else {
                         // Fallback for UI if backend route not ready
                         console.warn("Backend auth route not ready");
                         App.ui.showToast(`Magic Link request sent to ${email}`);
                         App.ui.toggleSettings();
                    }
                } catch (e) {
                    App.ui.showToast(`Magic Link request sent (Offline)`);
                    App.ui.toggleSettings();
                } finally {
                    App.ui.setLoading(false);
                }
            },

            getPlan() {
                return localStorage.getItem('askdesk_plan') || 'starter';
            },
            setPlan(plan) {
                localStorage.setItem('askdesk_plan', plan);
                this.updateUI();
                App.ui.showToast(`Plan updated to ${App.config.plans[plan].label}`);
            },
            getUsageToday() {
                const key = `askdesk_usage_${new Date().toISOString().slice(0, 10)}`;
                const data = JSON.parse(localStorage.getItem(key) || '{"count":0}');
                return data.count;
            },
            incrementUsage() {
                const plan = this.getPlan();
                if (plan === 'enterprise') return;

                const key = `askdesk_usage_${new Date().toISOString().slice(0, 10)}`;
                const count = this.getUsageToday() + 1;
                localStorage.setItem(key, JSON.stringify({ count }));
                this.updateUI();
            },
            isLimitReached() {
                const plan = this.getPlan();
                if (plan === 'enterprise') return false;
                
                const limit = App.config.plans[plan].dailyLimit;
                return this.getUsageToday() >= limit;
            },
            canCopy() { 
                const planKey = this.getPlan();
                const planConfig = App.config.plans[planKey];
                return planConfig ? planConfig.canCopy : false; 
            },
            canExport(type) { 
                const planKey = this.getPlan();
                const planConfig = App.config.plans[planKey];
                if (!planConfig) return false;
                const allowed = planConfig.canExport; // Correct property name
                return allowed.includes(type); 
            },
            setupCopyGuard() {
                ['contextmenu', 'copy', 'cut'].forEach(event => {
                    document.addEventListener(event, (e) => {
                        if (!this.canCopy() && (e.target.tagName === 'TEXTAREA' || e.target.closest('.protected-text'))) {
                            e.preventDefault();
                            App.ui.showToast(App.i18n.t('copyRestricted'));
                        }
                    });
                });
            },
            
            // FIXED: Cycle Plan now ONLY redirects, does NOT update local state
            cyclePlan() { 
                const current = this.getPlan();
                let nextPlan = 'pro';
                
                if (current === 'starter') nextPlan = 'pro';
                else if (current === 'pro') nextPlan = 'enterprise';
                else nextPlan = 'enterprise'; 
                
                // Redirect to payment page
                // New Confirmation Step
                const msg = App.i18n.currentLang === 'tr' 
                    ? "GÃ¼venli Ã¶deme sayfasÄ±na yÃ¶nlendirileceksiniz. Devam etmek istiyor musunuz?" 
                    : "You are about to be redirected to the secure payment page. Do you want to continue?";

                if (confirm(msg)) {
                    const url = `${App.config.UPGRADE_URL}?plan=${nextPlan}`;
                    window.open(url, '_blank');
                }
            },
            
            updateUI() {
                const planKey = this.getPlan();
                const plan = App.config.plans[planKey];
                const usage = this.getUsageToday();
                const limitStr = plan.dailyLimit === Infinity ? "Unlimited" : plan.dailyLimit;

                // Update Badges
                const pBadge = document.getElementById('planBadge');
                pBadge.innerText = plan.label;
                let colorClass = "bg-slate-700 text-slate-300";
                if(planKey === 'pro') colorClass = "bg-green-900 text-green-100 border-green-600";
                if(planKey === 'enterprise') colorClass = "bg-purple-900 text-purple-100 border-purple-600";
                pBadge.className = `h-8 px-3 text-[10px] md:text-[10px] font-bold rounded uppercase tracking-wide border transition-colors cursor-pointer flex items-center justify-center min-w-[4rem] ${colorClass}`;

                document.getElementById('usageBadge').innerText = `${usage} / ${limitStr}`;

                // Handle Limits
                const isLimit = this.isLimitReached();
                const genBtn = document.getElementById('analyzeBtn');
                const btnText = document.getElementById('btnText');
                
                if (isLimit) {
                    genBtn.disabled = true;
                    genBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    btnText.innerText = App.i18n.t('upgradeBtn');
                    document.getElementById('previewUpgradeBtn').classList.remove('hidden');
                } else {
                    genBtn.disabled = false;
                    genBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                    btnText.innerText = App.i18n.t('analyzeBtn');
                    document.getElementById('previewUpgradeBtn').classList.add('hidden');
                }

                // Handle Export Buttons Visibility
                ['excel', 'csv', 'json'].forEach(type => {
                    const btn = document.getElementById(`btnExport${type.charAt(0).toUpperCase() + type.slice(1)}`);
                    if(btn) {
                        if(this.canExport(type)) btn.classList.remove('hidden');
                        else btn.classList.add('hidden');
                    }
                });
                
                // Toggle copy guard class
                const areas = document.querySelectorAll('.protected-text');
                areas.forEach(el => {
                    if(this.canCopy()) el.classList.remove('select-none'); 
                    else el.classList.add('select-none');
                });
            }
        },

        // --- PROMPT BUILDER ---
        promptBuilder: {
            build(domain, qLang, aLang, sourceText, retryCount, hasImage, prevQuestion, chunkText, docName) {
                const activeText = chunkText || sourceText;
                const constraints = retryCount > 0 ? `- STRICTER MODE: Ensure Question is unambiguous.` : "";
                const notFoundTxt = App.i18n.translations[aLang]?.notFound || "Not found";
                const inputContext = hasImage ? `Input is an IMAGE. Perform OCR.` : `Input Text provided below.`;
                let prevContext = prevQuestion ? `\nCONSTRAINT: You previously asked "${prevQuestion}". Generate a DIFFERENT question.` : "";
                const sourceInjection = hasImage ? "" : `\n\nSOURCE TEXT SEGMENT:\n"""${activeText}"""\n\n`;
                const docContext = docName ? `\nCONTEXT DOCUMENT: "${docName}"` : "";

                return `
                System: AskDesk v2.9.22 (Global). Domain: ${domain.toUpperCase()}
                ${docContext}
                ${inputContext}
                Task: Generate JSON {question, answer, extract, citations}.
                1. Identify the most informative sentence in the Source Text.
                2. COPY that sentence EXACTLY as the 'extract' (Verbatim Copy).
                3. Formulate a professional Question in ${qLang}.
                4. TRANSLATE the 'extract' into ${aLang} to create the 'answer'.
                Rules:
                - If info not found, answer: "${notFoundTxt}", extract: "".
                - NO Markdown. STRICT JSON.
                ${constraints}
                ${prevContext}
                ${sourceInjection}
                `;
            }
        },

        // --- MAIN LOGIC ---
        logic: {
            calculateRealQuality(source, extract, answer, hasImage) {
                if (!extract || extract.length < 5) return { score: 0, reason: "No extract found" };
                let score = 100;
                const reasons = [];
                const normSource = source.replace(/\s+/g, ' ').toLowerCase();
                const normExtract = extract.replace(/\s+/g, ' ').toLowerCase();
                if (!hasImage && !normSource.includes(normExtract)) { 
                    score = 0; reasons.push("Grounding Failed: Extract not found in source text."); 
                } else { 
                    reasons.push("Grounding Verified (+50)"); reasons.push("Translation Mode (+50)");
                }
                return { score: Math.max(0, score), reasons };
            },
            calculateCapacity(textLen) {
                const planKey = App.billing.getPlan();
                const limits = App.config.plans[planKey];
                const estimatedQ = Math.max(1, Math.floor(textLen / 1500));
                return Math.min(estimatedQ, limits.maxBulk || 5);
            },
            async analyzeText(opts = {}) {
                if (App.billing.isLimitReached()) {
                    App.ui.showToast(App.i18n.t('limitReached'), 'upgrade');
                    App.billing.updateUI(); 
                    return;
                }

                const { retryCount = 0, groupId: forcedGroupId = null, version: forcedVersion = 0, prevQuestion = null, chunkText = null } = opts;
                const hasImage = !!App.data.currentImage;
                let sourceText = document.getElementById('sourceText').value.trim();
                const docName = document.getElementById('docName').value || "";
                const pageNum = document.getElementById('pageNum').value || "";

                if (!hasImage && sourceText.length < 50) return App.ui.showError(App.i18n.t('minCharsErr'));
                if(!App.data.bulkActive) App.ui.setLoading(true);
                
                const domain = document.getElementById('domainSelect').value;
                const qLang = document.getElementById('qLangSelect').value;
                const aLang = document.getElementById('aLangSelect').value;

                // GET USER ID
                const userId = localStorage.getItem('askdesk_user_email') || 'guest';

                try {
                    if (retryCount === 0 && !App.data.bulkActive) {
                         App.billing.incrementUsage();
                    }
                    
                    const promptStr = App.promptBuilder.build(domain, qLang, aLang, sourceText, retryCount, hasImage, prevQuestion, chunkText, docName);
                    
                    const payload = {
                        prompt: promptStr,
                        sourceText: hasImage ? "" : (chunkText || sourceText), 
                        imageDataUrl: hasImage ? App.data.currentImage : null,
                        meta: { domain, qLang, aLang, docName, pageNum },
                        regen: { nonce: Date.now() }
                    };

                    let response;
                    let usedUrl = App.api.current;
                    try {
                         response = await fetch(usedUrl + '/generate', { 
                             method: 'POST', 
                             headers: { 'Content-Type': 'application/json', 'X-AskDesk-User': userId }, 
                             body: JSON.stringify(payload), 
                             signal: App.data.abortController ? App.data.abortController.signal : null 
                        });
                    } catch(netErr) {
                         if(usedUrl !== App.api.fallback) {
                             usedUrl = App.api.fallback;
                             App.api.current = usedUrl; 
                             localStorage.setItem('askdesk_api_base', usedUrl); 
                             response = await fetch(usedUrl + '/generate', { 
                                 method: 'POST', 
                                 headers: { 'Content-Type': 'application/json', 'X-AskDesk-User': userId }, 
                                 body: JSON.stringify(payload) 
                            });
                         } else {
                             throw netErr;
                         }
                    }

                    if (!response.ok) {
                         if (response.status === 429 || response.status === 402) {
                            App.ui.showToast(App.i18n.t('limitReached'), 'upgrade');
                            throw new Error("Plan limit reached (Server).");
                         }
                         throw new Error(`Server Error: ${response.status}`);
                    }
                    const res = await response.json(); 
                    
                    if (res.error && (res.error === 'LIMIT_REACHED' || res.code === 'LIMIT_REACHED')) {
                        App.ui.showToast(App.i18n.t('limitReached'), 'upgrade');
                        throw new Error("Plan limit reached (Backend Logic).");
                    }

                    const activeSrc = chunkText || sourceText;
                    const realQual = this.calculateRealQuality(activeSrc, res.extract, res.answer, hasImage);
                    res.quality_score = realQual.score; res.quality_reasons = realQual.reasons;
                    
                    if (!hasImage && res.quality_score < 90 && retryCount < 1) return this.analyzeText({ ...opts, retryCount: retryCount + 1 });
                    
                    const groupId = forcedGroupId || crypto.randomUUID();
                    const version = forcedGroupId ? (forcedVersion + 1) : 1;
                    
                    if (App.data.bulkActive) return { result: res, grounding: {ok: res.quality_score>0}, domain, qLang, aLang, groupId, version, hasImage };
                    
                    App.data.previewState = { result: res, grounding: {ok: res.quality_score>0}, domain, qLang, aLang, groupId, version, hasImage };
                    App.ui.updatePreview(res, {ok: res.quality_score>0});
                } catch (e) { 
                    if (e.name !== 'AbortError') App.ui.showError(e.message); 
                    if(!App.data.bulkActive) App.ui.setLoading(false);
                    throw e; 
                } finally { if (!App.data.bulkActive) App.ui.setLoading(false); }
            },
            async startGeneration() {
                if (App.data.bulkActive) return;
                const bulkInput = document.getElementById('bulkRange');
                const requestedCount = document.getElementById('bulkPanel').classList.contains('hidden') ? 1 : parseInt(bulkInput.value);
                
                if (requestedCount === 1) { 
                    try { await this.analyzeText(); } catch(e) { console.warn("Analysis failed:", e); }
                    return; 
                }
                
                App.data.bulkActive = true; App.data.abortController = new AbortController(); App.ui.setLoading(true);
                const sourceText = document.getElementById('sourceText').value;
                const chunkSize = Math.floor(sourceText.length / requestedCount);
                document.getElementById('bulkProgressContainer').classList.remove('hidden');
                document.getElementById('bulkStatusText').classList.remove('hidden');
                const pBar = document.getElementById('bulkProgressBar');
                const pText = document.getElementById('bulkStatusText');
                let lowQualityCount = 0;
                for (let i = 0; i < requestedCount; i++) {
                    if (App.billing.isLimitReached()) {
                        App.ui.showToast(App.i18n.t('limitReached'), 'upgrade');
                        break;
                    }
                    App.billing.incrementUsage();

                    pText.innerText = `Generating ${i+1}/${requestedCount}...`;
                    pBar.style.width = `${((i)/requestedCount)*100}%`;
                    const start = i * chunkSize;
                    const end = start + chunkSize + 500;
                    const chunk = sourceText.substring(start, end);
                    try {
                        const data = await this.analyzeText({ chunkText: chunk });
                        if (data.result.quality_score < 50) { lowQualityCount++; if (lowQualityCount >= 3) { App.ui.showToast("Stopping: Quality dropped too low.", "warning"); break; } } else { lowQualityCount = 0; }
                        App.data.previewState = data; this.addToLog();
                    } catch (e) { if (e.name === 'AbortError') break; }
                }
                pBar.style.width = '100%'; App.data.bulkActive = false; App.ui.setLoading(false);
                setTimeout(() => { document.getElementById('bulkProgressContainer').classList.add('hidden'); document.getElementById('bulkStatusText').classList.add('hidden'); }, 2000);
            },
            stopBulk() { if (App.data.abortController) { App.data.abortController.abort(); App.data.bulkActive = false; App.ui.setLoading(false); App.ui.showToast("Generation Stopped."); } },
            regenerate() { 
                if (!App.data.previewState) return; 
                const { groupId, version, result } = App.data.previewState; 
                this.analyzeText({ retryCount: 0, groupId, version, prevQuestion: result.question }).catch(e => console.warn("Regen failed:", e));
            },
            addToLog() {
                if (!App.data.previewState) return;
                const s = App.data.previewState; const r = s.result;
                const currentDoc = document.getElementById('docName').value || "N/A";
                const currentPage = document.getElementById('pageNum').value || "-";
                
                const entry = { id: crypto.randomUUID(), groupId: s.groupId, version: s.version, docName: currentDoc, pageNum: currentPage, domain: s.domain, qLang: s.qLang, aLang: s.aLang, question: r.question, answer: r.answer, extract: r.extract, qualityScore: r.quality_score, status: "Draft", reviewerNotes: s.hasImage ? "[From Image Source]" : "", createdAtISO: new Date().toISOString() };
                App.data.qaLog.push(entry); this.renderTable();
                if (!App.data.bulkActive) { App.ui.showToast(App.i18n.t('success')); document.getElementById('questionOutput').value = ''; document.getElementById('answerOutput').value = ''; document.getElementById('qualityBox').classList.add('hidden'); document.getElementById('addToLogBtn').disabled = true; document.getElementById('regenerateBtn').disabled = true; App.data.previewState = null; }
            },
            renderTable() {
                const tbody = document.getElementById('logTableBody');
                const f = { domain: 'all', status: 'all', search: '' };
                tbody.innerHTML = '';
                [...App.data.qaLog].reverse().forEach((item) => {
                    const tr = document.createElement('tr'); tr.className = "hover:bg-slate-800/50 transition border-b border-slate-800/50 group";
                    tr.innerHTML = `<td class="px-4 py-3 text-slate-500 font-mono text-[10px] align-top">v${item.version}</td><td class="px-4 py-3 align-top"><div class="text-white text-xs font-bold truncate w-24" title="${item.docName}">${item.docName}</div><div class="text-brand-primary text-[10px]">p.${item.pageNum}</div></td><td class="px-4 py-3 align-top"><div class="mb-1 text-slate-200 text-xs font-medium">${item.question}</div><div class="text-slate-400 text-[10px] font-mono truncate w-64" title="${item.answer}">${item.answer}</div><div class="mt-1 flex gap-2"><span class="text-[9px] px-1 rounded ${item.qualityScore >= 70 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">QS: ${item.qualityScore}</span>${item.reviewerNotes ? `<i class="fa-solid fa-note-sticky text-yellow-500 text-[10px]" title="${item.reviewerNotes}"></i>` : ''}</div></td><td class="px-4 py-3 align-top"><select onchange="App.logic.updateStatus('${item.id}', this.value)" class="bg-slate-800 border border-slate-600 text-[9px] text-white rounded px-1 py-0.5 outline-none mb-1 w-full"><option value="Draft" ${item.status==='Draft'?'selected':''}>Draft</option><option value="Reviewed" ${item.status==='Reviewed'?'selected':''}>Review</option><option value="Approved" ${item.status==='Approved'?'selected':''}>Approve</option></select><button onclick="App.logic.openNotes('${item.id}')" class="text-[9px] text-brand-info hover:underline flex items-center gap-1"><i class="fa-solid fa-pen"></i> Notes</button></td><td class="px-4 py-3 align-top text-right"><button onclick="App.logic.deleteEntry('${item.id}')" class="text-slate-600 hover:text-red-400 transition opacity-0 group-hover:opacity-100 p-2"><i class="fa-solid fa-trash"></i></button></td>`;
                    tbody.appendChild(tr);
                });
            },
            deleteEntry(id) { App.data.qaLog = App.data.qaLog.filter(x => x.id !== id); this.renderTable(); },
            clearLog() { if (confirm('Clear?')) { App.data.qaLog = []; this.renderTable(); } },
            updateStatus(id, newStatus) {
                const item = App.data.qaLog.find(x => x.id === id);
                if (item) { item.status = newStatus; this.renderTable(); }
            },
            openNotes(id) {
                App.data.editingNoteId = id;
                const item = App.data.qaLog.find(x => x.id === id);
                document.getElementById('notesInput').value = item.reviewerNotes || '';
                document.getElementById('notesModal').classList.remove('hidden');
            },
            saveNotes() {
                const item = App.data.qaLog.find(x => x.id === App.data.editingNoteId);
                if (item) { item.reviewerNotes = document.getElementById('notesInput').value; this.renderTable(); }
                document.getElementById('notesModal').classList.add('hidden');
            }
        },

        // --- EXPORTERS ---
        exporters: {
            sanitize: (v) => (typeof v === 'string' && ['=','+','-','@'].includes(v[0]) ? "'" + v : v),
            getDataForExport() {
                return App.data.qaLog.map(i => ({
                    ID: i.id, GroupID: i.groupId, Version: i.version,
                    Doc: this.sanitize(i.docName), Page: this.sanitize(i.pageNum),
                    Domain: i.domain, QLang: i.qLang, ALang: i.aLang,
                    Question: this.sanitize(i.question), Answer: this.sanitize(i.answer),
                    Quality: i.qualityScore, Grounded: i.groundingOk,
                    Status: i.status, Notes: this.sanitize(i.reviewerNotes),
                    Created: i.createdAtISO
                }));
            },
            toExcel() {
                if(!App.billing.canExport('excel')) return App.ui.showToast(App.i18n.t('copyRestricted')); 
                if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
                const ws = XLSX.utils.json_to_sheet(this.getDataForExport());
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "QA Data");
                XLSX.writeFile(wb, `AskDesk_PROD_${new Date().toISOString().slice(0,10)}.xlsx`);
            },
            toCSV() {
                if(!App.billing.canExport('csv')) return App.ui.showToast(App.i18n.t('copyRestricted')); 
                if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
                const data = this.getDataForExport();
                const headers = Object.keys(data[0]).join(',');
                const rows = data.map(row => Object.values(row).map(v => `"${String(v || '').replace(/"/g,'""')}"`).join(','));
                const csv = "\uFEFF" + [headers, ...rows].join('\n');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
                a.download = `AskDesk_PROD.csv`;
                a.click();
            },
            toJSON() {
                if(!App.billing.canExport('json')) return App.ui.showToast(App.i18n.t('copyRestricted'));
                if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(App.data.qaLog,null,2)], {type: 'application/json'}));
                a.download = `AskDesk_PROD.json`;
                a.click();
            }
        },

        // --- UI MODULE ---
        ui: {
            init() {
                try {
                    const en = App.i18n.translations.en;
                    App.config.languages.forEach(l => { if (!App.i18n.translations[l.code]) App.i18n.translations[l.code] = { ...en }; });
                    const populate = (id, options) => { const el = document.getElementById(id); if(el) { if(!id.startsWith('filter')) el.innerHTML = ''; options.forEach(o => el.add(new Option(o.label, o.id || o.code))); } };
                    populate('domainSelect', App.config.domains); populate('filterDomain', App.config.domains);
                    ['qLangSelect', 'aLangSelect', 'uiLangSelect'].forEach(id => populate(id, App.config.languages));
                    const prefs = App.storage.getPrefs();
                    document.getElementById('uiLangSelect').value = prefs.uiLang;
                    document.getElementById('domainSelect').value = prefs.domain || 'general';
                    this.changeLanguage(prefs.uiLang);
                    App.billing.init();
                    
                    // Fixed: Safely get input
                    const apiInput = document.getElementById('apiUrlInput');
                    if (apiInput) apiInput.value = App.api.current;
                } catch(e) { console.error(e); }
            },
            cyclePlan() { 
                App.billing.cyclePlan();
            },
            handleTextChange() {
                const val = document.getElementById('sourceText').value; this.updateCharCount();
                const maxQ = App.logic.calculateCapacity(val.length);
                const bulkPanel = document.getElementById('bulkPanel'); const range = document.getElementById('bulkRange'); const label = document.getElementById('bulkLimitLabel');
                document.getElementById('densityScore').innerText = Math.floor(val.length / 1500);
                if (maxQ > 1) { bulkPanel.classList.remove('hidden'); range.max = maxQ; if(parseInt(range.value) > maxQ) { range.value = 1; this.updateBulkLabel(1); } label.innerText = `Max: ${maxQ}`; } else { bulkPanel.classList.add('hidden'); range.value = 1; this.updateBulkLabel(1); }
            },
            updateBulkLabel(val) { document.getElementById('bulkValue').innerText = val; },
            changeLanguage(code) { App.i18n.currentLang = code; App.i18n.updateUI(); App.storage.savePrefs({ uiLang: code }); },
            toggleSettings() { document.getElementById('settingsPanel').classList.toggle('hidden'); },
            updatePlanBadge() { const plan = App.storage.getPlan(); const el = document.getElementById('planBadge'); el.innerText = plan; let colors = "bg-slate-700 text-slate-300"; if(plan === 'Pro') colors = "bg-green-900 text-green-300 border-green-700"; if(plan === 'Enterprise') colors = "bg-purple-900 text-purple-300 border-purple-700"; el.className = `h-8 px-3 text-[10px] md:text-[10px] font-bold rounded uppercase tracking-wide border transition-colors cursor-pointer flex items-center justify-center ${colors}`; },
            updateCharCount() { const len = document.getElementById('sourceText').value.length; document.getElementById('charCount').innerText = `${len} chars`; },
            clearInput() { document.getElementById('sourceText').value = ''; document.getElementById('sourceText').classList.remove('hidden'); document.getElementById('imagePreviewContainer').classList.add('hidden'); App.data.currentImage = null; this.updateCharCount(); this.handleTextChange(); },
            handleFileUpload(input) {
                const file = input.files[0];
                if (!file) return;
                if (file.type.startsWith('image/')) { const r = new FileReader(); r.onload = (e) => { App.data.currentImage = e.target.result; document.getElementById('previewImgElement').src = e.target.result; document.getElementById('sourceText').classList.add('hidden'); document.getElementById('imagePreviewContainer').classList.remove('hidden'); document.getElementById('imagePreviewContainer').classList.add('flex'); App.ui.showToast("Image loaded."); }; r.readAsDataURL(file); input.value = ''; return; }
                const name = file.name.toLowerCase();
                
                // PDF Parsing Fix
                if (name.endsWith('.pdf')) {
                    App.ui.showToast("Parsing PDF...");
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        try {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = "";
                            for(let i=1; i<=pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                // FIX: Use newline instead of space to preserve structure
                                const pageText = textContent.items.map(item => item.str).join('\n');
                                fullText += pageText + "\n\n";
                            }
                            document.getElementById('sourceText').value = fullText;
                            App.ui.handleTextChange();
                            App.ui.showToast("PDF Loaded!");
                        } catch (err) { App.ui.showError("PDF Error: " + err.message); }
                    };
                    reader.readAsArrayBuffer(file);
                }
                else if (name.endsWith('.docx')) { 
                    mammoth.extractRawText({arrayBuffer: file}).then(r => { document.getElementById('sourceText').value = r.value; App.ui.handleTextChange(); }).catch(e => console.error(e)); 
                }
                else if (name.endsWith('.xlsx')) {
                     const r = new FileReader(); r.onload = (e) => { 
                         const wb = XLSX.read(e.target.result, {type:'array'}); 
                         const ws = wb.Sheets[wb.SheetNames[0]]; 
                         document.getElementById('sourceText').value = XLSX.utils.sheet_to_csv(ws); 
                         App.ui.handleTextChange(); 
                     }; r.readAsArrayBuffer(file); 
                }
                else { const r = new FileReader(); r.onload = (e) => { document.getElementById('sourceText').value = e.target.result; App.ui.handleTextChange(); }; r.readAsText(file); }
                input.value = '';
            },
            setLoading(isLoading) {
                const btn = document.getElementById('analyzeBtn'); btn.disabled = isLoading && !App.data.bulkActive; 
                const stopOverlay = document.getElementById('stopBtnOverlay'); const btnText = document.getElementById('btnText'); const icon = document.getElementById('btnIcon'); const loader = document.getElementById('btnLoader');
                if(isLoading) { if (App.data.bulkActive) { stopOverlay.classList.remove('hidden'); } else { icon.classList.add('hidden'); loader.classList.remove('hidden'); } } else { stopOverlay.classList.add('hidden'); icon.classList.remove('hidden'); loader.classList.add('hidden'); }
            },
            updatePreview(res, grounding) {
                document.getElementById('questionOutput').value = res.question; document.getElementById('answerOutput').value = res.answer; document.getElementById('qualityBox').classList.remove('hidden');
                document.getElementById('qScoreBadge').innerText = res.quality_score + "%"; document.getElementById('groundingBadge').innerText = grounding.ok ? "PASS" : "FAIL";
                document.getElementById('extractPreview').innerText = res.extract || "(No extract)";
                this.enableAddButton(true); document.getElementById('regenerateBtn').disabled = false; document.getElementById('regenerateBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            },
            enableAddButton(enable) { const btn = document.getElementById('addToLogBtn'); btn.disabled = !enable; if(enable) { btn.classList.replace('bg-slate-800','bg-brand-success'); btn.classList.replace('text-slate-500','text-white'); btn.classList.remove('cursor-not-allowed'); } else { btn.classList.replace('bg-brand-success','bg-slate-800'); btn.classList.replace('text-white','text-slate-500'); btn.classList.add('cursor-not-allowed'); } },
            showError: (msg, details) => { const box = document.getElementById('errorBox'); document.getElementById('errorMsg').innerText = msg; const detEl = document.getElementById('errorDetails'); if(details) detEl.innerText = details; box.classList.remove('hidden'); },
            showToast: (msg, actionType) => { 
                const t = document.getElementById('toast'); 
                const btn = document.getElementById('toastActionBtn'); 
                
                // Fix: Check if p tag exists inside toast
                const pTag = t.querySelector('p');
                if(pTag) pTag.innerText = msg;

                if (btn) {
                    if (actionType === 'upgrade') { 
                        btn.classList.remove('hidden'); 
                        btn.href = App.config.UPGRADE_URL; 
                    } else { 
                        btn.classList.add('hidden'); 
                    }
                }
                
                t.classList.remove('translate-y-24'); 
                setTimeout(() => t.classList.add('translate-y-24'), 4000); 
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.ui.init());
    </script>
</body>
</html>


