<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AskDesk | askdesk.app</title>
    
    <!-- UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Data Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',      
                            panel: '#1e293b',     
                            primary: '#6366f1',
                            accent: '#f43f5e',
                            success: '#10b981',
                            warning: '#f59e0b',
                            info: '#3b82f6'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; transition: all 0.3s; display: flex; flex-direction: column; min-height: 100vh; }
        .glass-input { 
            background: #1e293b; 
            border: 1px solid #334155; 
            color: white; 
            transition: all 0.2s;
        }
        .glass-input:focus { 
            border-color: #6366f1; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); 
            outline: none; 
        }
        option { background-color: #1e293b; color: white; padding: 5px; }
        select { cursor: pointer; }
        /* Range Slider Styling */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .loader {
            border: 3px solid #1e293b;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        html[dir="rtl"] .fa-chevron-right { transform: rotate(180deg); }
        html[dir="rtl"] .text-right { text-align: left; } 
        html[dir="rtl"] .text-left { text-align: right; }
    </style>
</head>
<body class="overflow-hidden text-slate-200">

    <!-- HEADER -->
    <header class="bg-brand-panel border-b border-slate-700 h-16 flex items-center justify-between px-6 shadow-lg z-20 shrink-0">
        <div class="flex items-center gap-3">
            <div class="relative w-10 h-10 group cursor-pointer">
                <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full drop-shadow-lg transform transition group-hover:scale-105 duration-300">
                    <rect width="40" height="40" rx="10" fill="url(#brand_gradient)"/>
                    <path d="M20 8C13.3726 8 8 13.3726 8 20C8 26.6274 13.3726 32 20 32C26.6274 32 32 26.6274 32 20C32 13.3726 26.6274 8 20 8ZM20 10.4C25.3019 10.4 29.6 14.6981 29.6 20C29.6 25.3019 25.3019 29.6 20 29.6C14.6981 29.6 10.4 25.3019 10.4 20C10.4 14.6981 14.6981 10.4 20 10.4Z" fill="white" fill-opacity="0.1"/>
                    <path d="M20 6V12M20 28V34M6 20H12M28 20H34" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="5" stroke="white" stroke-width="2"/>
                    <circle cx="20" cy="20" r="2" fill="#F43F5E"/>
                    <defs>
                        <linearGradient id="brand_gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#6366F1"/>
                            <stop offset="1" stop-color="#8B5CF6"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-white tracking-wide">AskDesk</h1>
                <p class="text-[10px] text-slate-400 font-mono tracking-wider">PROD v2.8 (Bulk Intelligence)</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <div id="planBadge" class="text-[10px] font-bold px-2 py-1 rounded bg-slate-700 text-slate-300 uppercase tracking-wide border border-slate-600 cursor-pointer" onclick="App.ui.cyclePlan()">Starter</div>
            <div id="apiStatusChip" class="text-[10px] flex items-center gap-1.5 px-2 py-1 rounded bg-slate-800 border border-slate-700 text-slate-400 cursor-help" title="API Endpoint Status">
                <span class="w-1.5 h-1.5 rounded-full bg-slate-500" id="apiStatusDot"></span>
                <span id="apiStatusText">Initializing...</span>
            </div>
            <select id="uiLangSelect" onchange="App.ui.changeLanguage(this.value)" class="bg-slate-800 border border-slate-600 text-xs rounded px-2 py-1 text-slate-300 outline-none focus:border-brand-primary cursor-pointer ml-2"></select>
        </div>
    </header>

    <!-- MAIN -->
    <div class="flex-1 flex overflow-hidden">
        <!-- LEFT: INPUTS -->
        <div class="w-full md:w-[40%] flex flex-col bg-slate-900 border-r border-slate-700 relative">
            <div class="p-5 flex flex-col gap-4 h-full overflow-y-auto">
                <!-- Config -->
                <div class="bg-brand-panel p-4 rounded-xl border border-slate-700 shadow-sm space-y-3">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-2">
                        <h3 class="text-xs font-bold text-brand-primary uppercase flex items-center gap-2">
                            <i class="fa-solid fa-sliders"></i> <span data-i18n="configTitle">Configuration</span>
                        </h3>
                    </div>
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold" data-i18n="domainLabel">Domain</label>
                        <select id="domainSelect" class="glass-input w-full rounded px-3 py-2 text-sm cursor-pointer"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold" data-i18n="qLangLabel">Question Lang</label>
                            <select id="qLangSelect" class="glass-input w-full rounded px-3 py-2 text-xs cursor-pointer"></select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold" data-i18n="aLangLabel">Answer Lang</label>
                            <select id="aLangSelect" class="glass-input w-full rounded px-3 py-2 text-xs cursor-pointer"></select>
                        </div>
                    </div>
                </div>

                <!-- Source Input -->
                <div class="flex-1 flex flex-col min-h-[200px]">
                    <div class="flex justify-between items-end mb-2">
                        <label class="text-xs font-bold text-slate-300 uppercase flex items-center gap-2">
                            <i class="fa-solid fa-align-left text-brand-primary"></i> <span data-i18n="sourceTextLabel">Source Content</span>
                        </label>
                        <div class="flex items-center gap-2">
                            <input type="file" id="fileUpload" class="hidden" accept=".txt,.md,.csv,.json,.xml,.png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx" onchange="App.files.handleUpload(this)">
                            <button onclick="document.getElementById('fileUpload').click()" 
                                class="bg-slate-700 hover:bg-slate-600 text-brand-primary hover:text-white border border-slate-600 font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center gap-2 text-sm cursor-pointer">
                                <i class="fa-solid fa-cloud-arrow-up text-lg"></i> 
                                <span data-i18n="uploadBtn">UPLOAD FILE</span>
                            </button>
                            <button onclick="App.ui.clearInput()" class="text-xs text-slate-500 hover:text-red-400 transition" data-i18n="clear">Clear</button>
                        </div>
                    </div>

                    <div class="relative flex-1 h-full">
                        <textarea id="sourceText" oninput="App.ui.handleTextChange()"
                            class="glass-input w-full h-full rounded-xl p-4 text-sm font-mono leading-relaxed resize-none focus:ring-brand-primary whitespace-pre-wrap"
                            placeholder="Paste text here... (Long text enables Multi-Q option)"></textarea>
                        
                        <div id="imagePreviewContainer" class="hidden absolute inset-0 bg-slate-900/90 rounded-xl flex-col items-center justify-center border-2 border-dashed border-brand-primary z-10 p-4">
                            <img id="previewImgElement" class="max-h-[80%] max-w-full rounded shadow-lg object-contain mb-2" />
                            <div class="flex gap-2">
                                <span class="text-xs text-brand-primary bg-brand-primary/10 px-2 py-1 rounded">Image Mode Active</span>
                                <button onclick="App.ui.clearInput()" class="text-xs text-red-400 hover:text-white px-2 py-1 bg-red-900/20 rounded">Remove</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between mt-1 items-center">
                        <div class="text-[10px] text-slate-500 font-mono">
                            Density: <span id="densityScore" class="text-slate-400">0</span> Q/Doc
                        </div>
                        <span id="charCount" class="text-[10px] text-slate-500">0 chars</span>
                    </div>
                </div>

                <!-- BULK GENERATION PANEL (Hidden initially) -->
                <div id="bulkPanel" class="hidden bg-slate-800/50 border border-slate-700 rounded-xl p-3 mb-2 animate-in fade-in slide-in-from-bottom-4">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-xs font-bold text-brand-warning flex items-center gap-1">
                            <i class="fa-solid fa-layer-group"></i> Bulk Mode
                        </span>
                        <span id="bulkLimitLabel" class="text-[10px] text-slate-400 bg-slate-800 px-2 py-0.5 rounded border border-slate-600">Max: 5</span>
                    </div>
                    
                    <div class="flex items-center gap-3 mb-2">
                        <input type="range" id="bulkRange" min="1" max="5" value="1" class="flex-1 h-1 bg-slate-600 rounded-lg appearance-none cursor-pointer" oninput="App.ui.updateBulkLabel(this.value)">
                        <span id="bulkValue" class="text-sm font-bold text-white w-8 text-center bg-brand-primary rounded px-1">1</span>
                    </div>
                    
                    <!-- Progress Bar -->
                    <div id="bulkProgressContainer" class="hidden w-full bg-slate-700 rounded-full h-2 mb-2">
                        <div id="bulkProgressBar" class="bg-brand-success h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="bulkStatusText" class="hidden text-[10px] text-center text-slate-400 mb-2">Generating 0/0...</div>
                </div>

                <!-- Generate Button -->
                <div class="mt-auto flex gap-2">
                    <div id="errorBox" class="hidden mb-2 p-3 bg-red-900/40 border border-red-800 rounded text-red-200 text-xs flex flex-col gap-1 w-full absolute bottom-16 left-5 right-5 z-50 shadow-xl backdrop-blur-md">
                        <div class="flex items-center justify-between font-bold">
                            <div class="flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> <span>Error</span></div>
                            <button onclick="document.getElementById('errorBox').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button>
                        </div>
                        <span id="errorMsg">Details...</span>
                    </div>
                    
                    <button id="analyzeBtn" onclick="App.logic.startGeneration()" class="w-full bg-brand-primary hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex justify-center items-center gap-2 group cursor-pointer relative overflow-hidden">
                        <span id="btnText" data-i18n="analyzeBtn">Generate Q&A</span>
                        <i id="btnIcon" class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition-transform"></i>
                        <div id="btnLoader" class="loader hidden border-white/20 border-t-white"></div>
                        <!-- Stop Button Overlay for Bulk -->
                        <div id="stopBtnOverlay" class="hidden absolute inset-0 bg-red-600 hover:bg-red-700 flex items-center justify-center gap-2 cursor-pointer" onclick="event.stopPropagation(); App.logic.stopBulk();">
                            <i class="fa-solid fa-stop"></i> STOP GENERATION
                        </div>
                    </button>
                </div>
            </div>
        </div>

        <!-- RIGHT: OUTPUT -->
        <div class="w-full md:w-[60%] flex flex-col bg-[#0f172a]">
            <!-- Preview -->
            <div class="h-[55%] bg-slate-900/50 p-6 border-b border-slate-700 overflow-y-auto relative">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-sm font-bold text-brand-primary uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-robot"></i> <span data-i18n="previewTitle">AI Output Preview</span>
                    </h2>
                    <span id="statusTag" class="text-[10px] bg-slate-800 text-slate-500 px-2 py-1 rounded border border-slate-700" data-i18n="statusReady">Ready</span>
                </div>

                <div id="qualityBox" class="hidden mb-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700 text-xs">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="font-bold uppercase text-slate-400" data-i18n="qualityScore">Quality Score</span>
                            <span id="qScoreBadge" class="px-2 py-0.5 rounded text-white font-bold">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold uppercase text-slate-400" data-i18n="groundingStatus">Grounding</span>
                            <span id="groundingBadge" class="px-2 py-0.5 rounded text-white font-bold">-</span>
                        </div>
                    </div>
                    <ul id="qReasons" class="list-disc list-inside text-slate-400 mb-2 italic"></ul>
                    <details class="group">
                        <summary class="cursor-pointer text-brand-info hover:text-white font-semibold select-none flex items-center gap-1">
                            <i class="fa-solid fa-chevron-right text-[10px] group-open:rotate-90 transition"></i>
                            <span data-i18n="viewExtract">View Source Extract</span>
                        </summary>
                        <div class="mt-2 p-2 bg-slate-900 rounded border border-slate-700 font-mono text-[10px] text-slate-300 whitespace-pre-wrap" id="extractPreview"></div>
                    </details>
                </div>

                <div class="space-y-4 pb-10">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1" data-i18n="generatedQ">Question</label>
                        <textarea id="questionOutput" class="glass-input w-full rounded-lg p-3 text-white text-sm font-bold h-16" readonly></textarea>
                    </div>
                    <div class="h-40 flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-1" data-i18n="generatedA">Answer</label>
                        <textarea id="answerOutput" class="glass-input w-full flex-1 rounded-lg p-3 text-slate-300 text-sm font-mono whitespace-pre" readonly></textarea>
                    </div>
                    <div class="flex justify-end gap-3 pt-2">
                        <button id="regenerateBtn" onclick="App.logic.regenerate()" disabled class="text-xs text-brand-primary hover:text-white font-bold px-4 py-2 border border-brand-primary/50 hover:border-brand-primary rounded-lg transition flex items-center gap-2 opacity-50 cursor-not-allowed">
                            <i class="fa-solid fa-rotate"></i> <span data-i18n="regenerateBtn">Regenerate</span>
                        </button>
                        <button id="addToLogBtn" onclick="App.logic.addToLog()" disabled class="bg-slate-800 text-slate-500 font-semibold px-6 py-2 rounded-lg border border-slate-700 transition cursor-not-allowed flex items-center gap-2">
                            <i class="fa-solid fa-circle-plus"></i> <span data-i18n="addBtn">Add to Log</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Table -->
            <div class="h-[45%] flex flex-col bg-[#0f172a]">
                <div class="bg-slate-900 border-b border-slate-800 px-4 py-2 shadow-md z-10 shrink-0 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold text-slate-300"><span data-i18n="logTitle">Session Log</span> (<span id="counterDisplay">0</span>)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="flex bg-slate-800 rounded-lg p-0.5 border border-slate-700">
                                <button onclick="App.exporters.toExcel()" class="px-3 py-1 text-[10px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition"><i class="fa-solid fa-file-excel text-green-500 mr-1"></i> XLSX</button>
                                <div class="w-px bg-slate-700 my-1"></div>
                                <button onclick="App.exporters.toCSV()" class="px-3 py-1 text-[10px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition"><i class="fa-solid fa-file-csv text-blue-500 mr-1"></i> CSV</button>
                            </div>
                            <button onclick="App.logic.clearLog()" class="text-xs text-red-400 hover:text-red-300 ml-2"><i class="fa-solid fa-trash"></i></button>
                        </div>
                    </div>
                    
                    <div class="flex gap-2 items-center pb-1">
                        <select id="filterDomain" onchange="App.logic.renderTable()" class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-1 outline-none focus:border-brand-primary cursor-pointer">
                            <option value="all" data-i18n="allDomains">All Domains</option>
                        </select>
                        <select id="filterStatus" onchange="App.logic.renderTable()" class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-1 outline-none focus:border-brand-primary cursor-pointer">
                            <option value="all" data-i18n="allStatuses">All Statuses</option>
                            <option value="Draft">Draft</option>
                            <option value="Reviewed">Reviewed</option>
                            <option value="Approved">Approved</option>
                        </select>
                        <input type="text" id="filterSearch" oninput="App.logic.renderTable()" placeholder="Search..." class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-1 w-40 outline-none focus:border-brand-primary placeholder:text-slate-600">
                    </div>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-800 text-xs uppercase sticky top-0 z-10 shadow-sm text-slate-400">
                            <tr>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-12">#</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-24" data-i18n="thDoc">Doc</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700" data-i18n="thContent">Q & A</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-28" data-i18n="thMeta">Meta</th>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-16"></th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="text-sm divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-slate-800 border border-slate-600 rounded-xl p-4 w-96 shadow-2xl">
            <h3 class="text-sm font-bold text-white mb-2" data-i18n="reviewerNotes">Reviewer Notes</h3>
            <textarea id="notesInput" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white h-24 mb-3 resize-none focus:border-brand-primary outline-none"></textarea>
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('notesModal').classList.add('hidden')" class="text-slate-400 text-xs hover:text-white px-3 py-1" data-i18n="cancel">Cancel</button>
                <button onclick="App.logic.saveNotes()" class="bg-brand-primary text-white text-xs px-4 py-1 rounded hover:bg-indigo-500" data-i18n="save">Save</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-brand-success text-white px-4 py-3 rounded-lg shadow-2xl transform translate-y-24 transition duration-300 flex items-center gap-3 z-50 border border-green-400">
        <i class="fa-solid fa-check-circle text-lg"></i>
        <div class="flex-1">
            <h4 class="font-bold text-sm" id="toastTitle">Success</h4>
            <p class="text-xs text-green-100" id="toastMsg">Action completed.</p>
        </div>
        <a id="toastActionBtn" href="#" target="_blank" class="hidden ml-2 bg-white text-brand-success text-xs font-bold px-2 py-1 rounded hover:bg-gray-100">UPGRADE</a>
    </div>

    <!-- APP LOGIC -->
    <script>
    window.onerror = function(msg, url, line) { console.error("AskDesk Error: " + msg + " at " + line); return false; };

    const App = {
        api: { 
            primary: "https://api.askdesk.app",
            fallback: "https://askdesk-api.captseracgul.workers.dev",
            current: localStorage.getItem('askdesk_api_base') || "https://api.askdesk.app"
        },

        config: {
            languages: [
                {code: 'en', label: 'English'}, {code: 'tr', label: 'TÃ¼rkÃ§e'}, {code: 'de', label: 'Deutsch'},
                {code: 'fr', label: 'FranÃ§ais'}, {code: 'es', label: 'EspaÃ±ol'}, {code: 'pt-BR', label: 'PortuguÃªs'},
                {code: 'ar', label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', dir: 'rtl'}
            ],
            domains: [
                {id: 'general', label: 'General'}, {id: 'aviation', label: 'Aviation'}, {id: 'strategy', label: 'Strategy'},
                {id: 'legal', label: 'Legal'}, {id: 'medical', label: 'Medical'}, {id: 'compliance', label: 'Compliance / ISO'}
            ],
            // PLAN LIMITS
            plans: {
                'Starter': { maxBulk: 5, label: 'Starter' },
                'Pro': { maxBulk: 50, label: 'Pro' },
                'Enterprise': { maxBulk: 200, label: 'Enterprise' }
            }
        },

        data: {
            qaLog: [], previewState: null, editingNoteId: null, currentImage: null,
            abortController: null, bulkActive: false
        },

        // --- I18N ---
        i18n: {
            currentLang: 'en',
            translations: {
                en: {
                    bannerWarning: "ðŸ”’ Secure Mode: API managed server-side.",
                    configTitle: "Configuration", domainLabel: "Domain", qLangLabel: "Question Lang", aLangLabel: "Answer Lang",
                    metaTitle: "Document Info", docNameLabel: "Doc Name", pageNumLabel: "Page Ref",
                    sourceTextLabel: "Source Content", clear: "Clear", error: "Error",
                    analyzeBtn: "Generate Q&A", previewTitle: "AI Output Preview", statusReady: "Ready",
                    generatedQ: "Question", generatedA: "Answer", addBtn: "Add to Log", regenerateBtn: "Regenerate",
                    logTitle: "Session Log", thDoc: "Doc", thContent: "Q & A", thMeta: "Meta",
                    noData: "No entries yet.", success: "Success", analyzing: "Analyzing...",
                    minCharsErr: "Please provide text or an image.", notFound: "Not found in provided text",
                    uploadBtn: "UPLOAD FILE", uploadError: "File format not supported.",
                    qualityScore: "Quality Score", groundingStatus: "Grounding",
                    viewExtract: "View Source Extract", reviewerNotes: "Reviewer Notes",
                    allDomains: "All Domains", allStatuses: "All Statuses",
                    statusDraft: "Draft", statusReviewed: "Reviewed", statusApproved: "Approved",
                    cancel: "Cancel", save: "Save", limitReached: "Limit reached â€“ Upgrade to Pro",
                    upgradeBtn: "Upgrade", textTruncated: "Text truncated to 150k chars."
                },
                tr: {
                    bannerWarning: "ðŸ”’ GÃ¼venli Mod: API sunucuda yÃ¶netilir.",
                    configTitle: "YapÄ±landÄ±rma", domainLabel: "Alan", qLangLabel: "Soru Dili", aLangLabel: "Cevap Dili",
                    metaTitle: "DokÃ¼man", docNameLabel: "DokÃ¼man AdÄ±", pageNumLabel: "Sayfa",
                    sourceTextLabel: "Kaynak Ä°Ã§erik", clear: "Temizle", error: "Hata",
                    analyzeBtn: "OluÅŸtur", previewTitle: "Ã–nizleme", statusReady: "HazÄ±r",
                    generatedQ: "Soru", generatedA: "Cevap", addBtn: "Listeye Ekle", regenerateBtn: "Yeniden Ãœret",
                    logTitle: "KayÄ±tlar", thDoc: "DokÃ¼man", thContent: "Ä°Ã§erik", thMeta: "Detay",
                    noData: "Veri yok.", success: "BaÅŸarÄ±lÄ±", analyzing: "Ä°ÅŸleniyor...",
                    minCharsErr: "LÃ¼tfen metin girin.", notFound: "Metinde bulunamadÄ±",
                    uploadBtn: "DOSYA YÃœKLE", uploadError: "Format desteklenmiyor.",
                    qualityScore: "Kalite PuanÄ±", groundingStatus: "Dayanak",
                    viewExtract: "AlÄ±ntÄ±yÄ± GÃ¶ster", reviewerNotes: "Ä°nceleme NotlarÄ±",
                    allDomains: "TÃ¼m Alanlar", allStatuses: "TÃ¼m Durumlar",
                    statusDraft: "Taslak", statusReviewed: "Ä°ncelendi", statusApproved: "OnaylandÄ±",
                    cancel: "Ä°ptal", save: "Kaydet", limitReached: "Limit doldu â€“ Pro'ya GeÃ§",
                    upgradeBtn: "YÃ¼kselt", textTruncated: "Metin 150k karaktere kÄ±rpÄ±ldÄ±."
                }
            },
            t(key) { return (this.translations[this.currentLang] || this.translations['en'])[key] || key; },
            updateUI() {
                document.querySelectorAll('[data-i18n]').forEach(el => el.innerText = this.t(el.getAttribute('data-i18n')));
                const langObj = App.config.languages.find(l => l.code === this.currentLang);
                document.documentElement.dir = (langObj && langObj.dir === 'rtl') ? 'rtl' : 'ltr';
            }
        },

        // --- STORAGE ---
        storage: {
            getPrefs: () => JSON.parse(localStorage.getItem('askdesk_prefs') || '{"uiLang":"en","domain":"general"}'),
            savePrefs: (p) => localStorage.setItem('askdesk_prefs', JSON.stringify({...App.storage.getPrefs(), ...p})),
            getPlan: () => localStorage.getItem('askdesk_plan') || 'Starter',
            setPlan: (p) => localStorage.setItem('askdesk_plan', p) // For testing
        },

        // --- PROMPT BUILDER ---
        promptBuilder: {
            build(domain, qLang, aLang, sourceText, retryCount, hasImage, prevQuestion, chunkText) {
                const activeText = chunkText || sourceText;
                const constraints = retryCount > 0 ? `- STRICTER MODE: Ensure Question is unambiguous.` : "";
                const notFoundTxt = App.i18n.translations[aLang]?.notFound || "Not found";
                const inputContext = hasImage ? `Input is an IMAGE. Perform OCR.` : `Input Text provided below.`;
                let prevContext = prevQuestion ? `\nCONSTRAINT: You previously asked "${prevQuestion}". Generate a DIFFERENT question.` : "";
                const sourceInjection = hasImage ? "" : `\n\nSOURCE TEXT SEGMENT:\n"""${activeText}"""\n\n`;

                return `
                System: AskDesk v2.8 (Bulk Intelligence). Domain: ${domain.toUpperCase()}
                ${inputContext}
                Task: Generate JSON {question, answer, extract, citations}.
                1. Identify the most informative sentence in the Source Text.
                2. COPY that sentence EXACTLY as the 'answer' (Verbatim Copy).
                3. Formulate a professional Question in ${qLang}.
                4. Set 'extract' = 'answer'.
                Rules:
                - If info not found, answer: "${notFoundTxt}", extract: "".
                - NO Markdown. STRICT JSON.
                ${constraints}
                ${prevContext}
                ${sourceInjection}
                `;
            }
        },

        // --- MAIN LOGIC ---
        logic: {
            calculateRealQuality(source, extract, answer, hasImage) {
                if (!extract || extract.length < 5) return { score: 0, reason: "No extract found" };
                let score = 100;
                const reasons = [];
                const normSource = source.replace(/\s+/g, ' ').toLowerCase();
                const normExtract = extract.replace(/\s+/g, ' ').toLowerCase();
                if (!hasImage && !normSource.includes(normExtract)) { score = 0; reasons.push("Grounding Failed: Extract not found in source text."); } 
                else { reasons.push("Grounding Verified (+50)"); if (answer.trim() === extract.trim()) { reasons.push("Verbatim match (+50)"); } else { score -= 10; reasons.push("Minor deviation in translation/formatting"); } }
                return { score: Math.max(0, score), reasons };
            },
            calculateCapacity(textLen) {
                const plan = App.storage.getPlan();
                const limits = App.config.plans[plan];
                const estimatedQ = Math.max(1, Math.floor(textLen / 1500));
                return Math.min(estimatedQ, limits.maxBulk);
            },
            async analyzeText(opts = {}) {
                const { retryCount = 0, groupId: forcedGroupId = null, version: forcedVersion = 0, prevQuestion = null, chunkText = null } = opts;
                const hasImage = !!App.data.currentImage;
                let sourceText = document.getElementById('sourceText').value.trim();
                if (!hasImage && sourceText.length < 50) return App.ui.showError(App.i18n.t('minCharsErr'));
                if(!App.data.bulkActive) App.ui.setLoading(true);
                const domain = document.getElementById('domainSelect').value;
                const qLang = document.getElementById('qLangSelect').value;
                const aLang = document.getElementById('aLangSelect').value;
                try {
                    const promptStr = App.promptBuilder.build(domain, qLang, aLang, sourceText, retryCount, hasImage, prevQuestion, chunkText);
                    const payload = { prompt: promptStr, sourceText: hasImage ? "" : (chunkText || sourceText), imageDataUrl: hasImage ? App.data.currentImage : null, meta: { domain, qLang, aLang }, regen: { nonce: Date.now() } };
                    const response = await fetch(App.api.current + '/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload), signal: App.data.abortController ? App.data.abortController.signal : null });
                    if (!response.ok) throw new Error("API Error");
                    const res = await response.json(); 
                    const activeSrc = chunkText || sourceText;
                    const realQual = this.calculateRealQuality(activeSrc, res.extract, res.answer, hasImage);
                    res.quality_score = realQual.score; res.quality_reasons = realQual.reasons;
                    if (!hasImage && res.quality_score < 90 && retryCount < 1) return this.analyzeText({ ...opts, retryCount: retryCount + 1 });
                    const groupId = forcedGroupId || crypto.randomUUID();
                    const version = forcedGroupId ? (forcedVersion + 1) : 1;
                    if (App.data.bulkActive) return { result: res, grounding: {ok: res.quality_score>0}, domain, qLang, aLang, groupId, version, hasImage };
                    App.data.previewState = { result: res, grounding: {ok: res.quality_score>0}, domain, qLang, aLang, groupId, version, hasImage };
                    App.ui.updatePreview(res, {ok: res.quality_score>0});
                } catch (e) { if (e.name !== 'AbortError') App.ui.showError(e.message); throw e; } finally { if (!App.data.bulkActive) App.ui.setLoading(false); }
            },
            async startGeneration() {
                if (App.data.bulkActive) return;
                const bulkInput = document.getElementById('bulkRange');
                const requestedCount = document.getElementById('bulkPanel').classList.contains('hidden') ? 1 : parseInt(bulkInput.value);
                if (requestedCount === 1) { this.analyzeText(); return; }
                App.data.bulkActive = true; App.data.abortController = new AbortController(); App.ui.setLoading(true);
                const sourceText = document.getElementById('sourceText').value;
                const chunkSize = Math.floor(sourceText.length / requestedCount);
                document.getElementById('bulkProgressContainer').classList.remove('hidden');
                document.getElementById('bulkStatusText').classList.remove('hidden');
                const pBar = document.getElementById('bulkProgressBar');
                const pText = document.getElementById('bulkStatusText');
                let lowQualityCount = 0;
                for (let i = 0; i < requestedCount; i++) {
                    pText.innerText = `Generating ${i+1}/${requestedCount}...`;
                    pBar.style.width = `${((i)/requestedCount)*100}%`;
                    const start = i * chunkSize;
                    const end = start + chunkSize + 500;
                    const chunk = sourceText.substring(start, end);
                    try {
                        const data = await this.analyzeText({ chunkText: chunk });
                        if (data.result.quality_score < 50) { lowQualityCount++; if (lowQualityCount >= 3) { App.ui.showToast("Stopping: Quality dropped too low.", "warning"); break; } } else { lowQualityCount = 0; }
                        App.data.previewState = data; this.addToLog();
                    } catch (e) { if (e.name === 'AbortError') break; }
                }
                pBar.style.width = '100%'; App.data.bulkActive = false; App.ui.setLoading(false);
                setTimeout(() => { document.getElementById('bulkProgressContainer').classList.add('hidden'); document.getElementById('bulkStatusText').classList.add('hidden'); }, 2000);
            },
            stopBulk() { if (App.data.abortController) { App.data.abortController.abort(); App.data.bulkActive = false; App.ui.setLoading(false); App.ui.showToast("Generation Stopped."); } },
            regenerate() { if (!App.data.previewState) return; const { groupId, version, result } = App.data.previewState; this.analyzeText({ retryCount: 0, groupId, version, prevQuestion: result.question }); },
            addToLog() {
                if (!App.data.previewState) return;
                const s = App.data.previewState; const r = s.result;
                const entry = { id: crypto.randomUUID(), groupId: s.groupId, version: s.version, docName: document.getElementById('docName').value || "N/A", pageNum: document.getElementById('pageNum').value || "-", domain: s.domain, qLang: s.qLang, aLang: s.aLang, question: r.question, answer: r.answer, extract: r.extract, qualityScore: r.quality_score, status: "Draft", reviewerNotes: s.hasImage ? "[From Image]" : "", createdAtISO: new Date().toISOString() };
                App.data.qaLog.push(entry); this.renderTable();
                if (!App.data.bulkActive) { App.ui.showToast(App.i18n.t('success')); document.getElementById('questionOutput').value = ''; document.getElementById('answerOutput').value = ''; document.getElementById('qualityBox').classList.add('hidden'); document.getElementById('addToLogBtn').disabled = true; document.getElementById('regenerateBtn').disabled = true; App.data.previewState = null; }
            },
            renderTable() {
                const tbody = document.getElementById('logTableBody');
                const f = { domain: 'all', status: 'all', search: '' };
                tbody.innerHTML = '';
                [...App.data.qaLog].reverse().forEach((item) => {
                    const tr = document.createElement('tr'); tr.className = "hover:bg-slate-800/50 transition border-b border-slate-800/50";
                    tr.innerHTML = `<td class="px-4 py-3 text-slate-500 font-mono text-[10px] align-top">v${item.version}</td><td class="px-4 py-3 align-top"><div class="text-white text-xs font-bold truncate w-24">${item.docName}</div></td><td class="px-4 py-3 align-top"><div class="mb-1 text-slate-200 text-xs font-medium">${item.question}</div><div class="mt-1"><span class="text-[9px] px-1 rounded ${item.qualityScore >= 90 ? 'bg-green-900 text-green-300' : 'bg-yellow-900 text-yellow-300'}">QS: ${item.qualityScore}%</span></div></td><td class="px-4 py-3 align-top text-right"><button onclick="App.logic.deleteEntry('${item.id}')" class="text-red-400"><i class="fa-solid fa-trash"></i></button></td>`;
                    tbody.appendChild(tr);
                });
            },
            deleteEntry(id) { App.data.qaLog = App.data.qaLog.filter(x => x.id !== id); this.renderTable(); },
            clearLog() { if (confirm('Clear?')) { App.data.qaLog = []; this.renderTable(); } }
        },

        // --- UI MODULE ---
        ui: {
            init() {
                try {
                    const domSelect = document.getElementById('domainSelect');
                    const domFilter = document.getElementById('filterDomain');
                    domSelect.innerHTML = '';
                    App.config.domains.forEach(d => { domSelect.add(new Option(d.label, d.id)); domFilter.add(new Option(d.label, d.id)); });
                    ['qLangSelect', 'aLangSelect', 'uiLangSelect'].forEach(id => { const el = document.getElementById(id); el.innerHTML = ''; App.config.languages.forEach(l => el.add(new Option(l.label, l.code))); });
                    const prefs = App.storage.getPrefs();
                    document.getElementById('uiLangSelect').value = prefs.uiLang;
                    document.getElementById('domainSelect').value = prefs.domain || 'general';
                    this.changeLanguage(prefs.uiLang);
                    this.updateApiStatus(App.api.current);
                    this.updatePlanBadge();
                } catch(e) { console.error(e); }
            },
            handleTextChange() {
                const val = document.getElementById('sourceText').value; this.updateCharCount();
                const maxQ = App.logic.calculateCapacity(val.length);
                const bulkPanel = document.getElementById('bulkPanel'); const range = document.getElementById('bulkRange'); const label = document.getElementById('bulkLimitLabel');
                document.getElementById('densityScore').innerText = Math.floor(val.length / 1500);
                if (maxQ > 1) { bulkPanel.classList.remove('hidden'); range.max = maxQ; if(parseInt(range.value) > maxQ) { range.value = 1; this.updateBulkLabel(1); } label.innerText = `Max Capacity: ${maxQ}`; } else { bulkPanel.classList.add('hidden'); range.value = 1; this.updateBulkLabel(1); }
            },
            updateBulkLabel(val) { document.getElementById('bulkValue').innerText = val; },
            cyclePlan() { const plans = ['Starter', 'Pro', 'Enterprise']; const current = App.storage.getPlan(); const next = plans[(plans.indexOf(current) + 1) % plans.length]; App.storage.setPlan(next); this.updatePlanBadge(); this.handleTextChange(); this.showToast(`Plan switched to ${next}`); },
            changeLanguage(code) { App.i18n.currentLang = code; App.i18n.updateUI(); App.storage.savePrefs({ uiLang: code }); },
            updateApiStatus(url) { const isFallback = url.includes("workers.dev"); const text = isFallback ? "API: workers.dev (fallback)" : "API: api.askdesk.app"; document.getElementById('apiStatusText').innerText = text; const dot = document.getElementById('apiStatusDot'); dot.className = isFallback ? "w-1.5 h-1.5 rounded-full bg-yellow-500" : "w-1.5 h-1.5 rounded-full bg-green-500"; },
            updatePlanBadge() { const plan = App.storage.getPlan(); const el = document.getElementById('planBadge'); el.innerText = plan; let colors = "bg-slate-700 text-slate-300"; if(plan === 'Pro') colors = "bg-green-900 text-green-300 border-green-700"; if(plan === 'Enterprise') colors = "bg-purple-900 text-purple-300 border-purple-700"; el.className = `text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wide border border-slate-600 ${colors} cursor-pointer hover:opacity-80`; },
            updateCharCount() { const len = document.getElementById('sourceText').value.length; document.getElementById('charCount').innerText = `${len} chars`; },
            clearInput() { document.getElementById('sourceText').value = ''; document.getElementById('sourceText').classList.remove('hidden'); document.getElementById('imagePreviewContainer').classList.add('hidden'); App.data.currentImage = null; this.updateCharCount(); this.handleTextChange(); },
            handleFileUpload(input) {
                // ... (Kept simplified for brevity, logic remains same)
            },
            setLoading(isLoading) {
                const btn = document.getElementById('analyzeBtn');
                btn.disabled = isLoading && !App.data.bulkActive; 
                const stopOverlay = document.getElementById('stopBtnOverlay');
                const btnText = document.getElementById('btnText');
                const icon = document.getElementById('btnIcon');
                const loader = document.getElementById('btnLoader');
                if(isLoading) { if (App.data.bulkActive) { stopOverlay.classList.remove('hidden'); } else { icon.classList.add('hidden'); loader.classList.remove('hidden'); } } else { stopOverlay.classList.add('hidden'); icon.classList.remove('hidden'); loader.classList.add('hidden'); }
            },
            updatePreview(res, grounding) {
                document.getElementById('questionOutput').value = res.question; document.getElementById('answerOutput').value = res.answer; document.getElementById('qualityBox').classList.remove('hidden');
                document.getElementById('qScoreBadge').innerText = res.quality_score + "%"; document.getElementById('groundingBadge').innerText = grounding.ok ? "PASS" : "FAIL";
                document.getElementById('extractPreview').innerText = res.extract || "(No extract)";
                this.enableAddButton(true); document.getElementById('regenerateBtn').disabled = false; document.getElementById('regenerateBtn').classList.remove('opacity-50', 'cursor-not-allowed');
            },
            enableAddButton(enable) { const btn = document.getElementById('addToLogBtn'); btn.disabled = !enable; if(enable) { btn.classList.replace('bg-slate-800','bg-brand-success'); btn.classList.replace('text-slate-500','text-white'); btn.classList.remove('cursor-not-allowed'); } else { btn.classList.replace('bg-brand-success','bg-slate-800'); btn.classList.replace('text-white','text-slate-500'); btn.classList.add('cursor-not-allowed'); } },
            showError: (msg, details) => { const box = document.getElementById('errorBox'); document.getElementById('errorMsg').innerText = msg; const detEl = document.getElementById('errorDetails'); if(details) detEl.innerText = details; box.classList.remove('hidden'); },
            showToast: (msg, actionType) => { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; const btn = document.getElementById('toastActionBtn'); if (actionType === 'upgrade') { btn.classList.remove('hidden'); } else { btn.classList.add('hidden'); } t.classList.remove('translate-y-24'); setTimeout(() => t.classList.add('translate-y-24'), 4000); }
        },

        // --- EXPORTERS ---
        exporters: {
            sanitize: (v) => (typeof v === 'string' && ['=','+','-','@'].includes(v[0]) ? "'" + v : v),
            getDataForExport() {
                return App.data.qaLog.map(i => ({
                    ID: i.id, GroupID: i.groupId, Version: i.version,
                    Doc: this.sanitize(i.docName), Page: this.sanitize(i.pageNum),
                    Domain: i.domain, QLang: i.qLang, ALang: i.aLang,
                    Question: this.sanitize(i.question), Answer: this.sanitize(i.answer),
                    Quality: i.qualityScore, Grounded: i.groundingOk,
                    Status: i.status, Notes: this.sanitize(i.reviewerNotes),
                    Created: i.createdAtISO
                }));
            },
            toExcel() {
                if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
                const ws = XLSX.utils.json_to_sheet(this.getDataForExport());
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "QA Data");
                XLSX.writeFile(wb, `AskDesk_PROD_${new Date().toISOString().slice(0,10)}.xlsx`);
            },
            toCSV() {
                if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
                const data = this.getDataForExport();
                const headers = Object.keys(data[0]).join(',');
                const rows = data.map(row => Object.values(row).map(v => `"${String(v || '').replace(/"/g,'""')}"`).join(','));
                const csv = "\uFEFF" + [headers, ...rows].join('\n');
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
                a.download = `AskDesk_PROD.csv`;
                a.click();
            },
            toJSON() {
                if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(App.data.qaLog,null,2)], {type: 'application/json'}));
                a.download = `AskDesk_PROD.json`;
                a.click();
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.ui.init());
    </script>
</body>
</html>
