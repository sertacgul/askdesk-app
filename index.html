<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AskDesk v2.4 | Server Edition</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- FontAwesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- SheetJS (Excel) -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>

<script>
tailwind.config = {
theme: {
extend: {
colors: {
brand: {
dark: '#0f172a',
panel: '#1e293b',
primary: '#6366f1', // Indigo
accent: '#f43f5e', // Rose
success: '#10b981',
warning: '#f59e0b',
info: '#3b82f6'
}
}
}
}
}
</script>
<style>
body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', system-ui, sans-serif; transition: all 0.3s; }
.glass-input {
background: #1e293b;
border: 1px solid #334155;
color: white;
transition: all 0.2s;
}
.glass-input:focus {
border-color: #6366f1;
box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
outline: none;
}
/* Windows Web Fix: Dropdown Options Visibility */
option { background-color: #1e293b; color: white; padding: 5px; }
select { cursor: pointer; }

::-webkit-scrollbar { width: 8px; height: 8px; }
::-webkit-scrollbar-track { background: #0f172a; }
::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
::-webkit-scrollbar-thumb:hover { background: #475569; }

.loader {
border: 3px solid #1e293b;
border-top: 3px solid #6366f1;
border-radius: 50%;
width: 20px; height: 20px;
animation: spin 1s linear infinite;
}
@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
html[dir="rtl"] .fa-chevron-right { transform: rotate(180deg); }
html[dir="rtl"] .text-right { text-align: left; }
html[dir="rtl"] .text-left { text-align: right; }
</style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-200">

<!-- WARNING BANNER -->
<div class="bg-brand-success/10 border-b border-brand-success/30 text-green-400 px-4 py-1 text-xs text-center font-semibold" data-i18n="bannerWarning">
ðŸ”’ Secure Mode: API Key is managed server-side. Do not paste PII.
</div>

<!-- HEADER -->
<header class="bg-brand-panel border-b border-slate-700 h-16 flex items-center justify-between px-6 shadow-lg z-20 shrink-0">
<div class="flex items-center gap-3">
<!-- GLOBAL LOGO -->
<div class="relative w-10 h-10 group cursor-pointer">
<svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full drop-shadow-lg transform transition group-hover:scale-105 duration-300">
<rect width="40" height="40" rx="10" fill="url(#brand_gradient)"/>
<path d="M20 8C13.3726 8 8 13.3726 8 20C8 26.6274 13.3726 32 20 32C26.6274 32 32 26.6274 32 20C32 13.3726 26.6274 8 20 8ZM20 10.4C25.3019 10.4 29.6 14.6981 29.6 20C29.6 25.3019 25.3019 29.6 20 29.6C14.6981 29.6 10.4 25.3019 10.4 20C10.4 14.6981 14.6981 10.4 20 10.4Z" fill="white" fill-opacity="0.1"/>
<path d="M20 6V12M20 28V34M6 20H12M28 20H34" stroke="white" stroke-width="2" stroke-linecap="round"/>
<circle cx="20" cy="20" r="5" stroke="white" stroke-width="2"/>
<circle cx="20" cy="20" r="2" fill="#F43F5E"/>
<defs>
<linearGradient id="brand_gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
<stop stop-color="#6366F1"/>
<stop offset="1" stop-color="#8B5CF6"/>
</linearGradient>
</defs>
</svg>
</div>

<div>
<h1 class="text-xl font-bold text-white tracking-wide">AskDesk <span class="text-brand-primary text-xs align-top">v2.4</span></h1>
<p class="text-[10px] text-slate-400 font-mono tracking-wider" data-i18n="appSubtitle">PROD SERVER EDITION</p>
</div>
</div>

<div class="flex items-center gap-4">
<!-- UI Language Selector -->
<select id="uiLangSelect" onchange="App.ui.changeLanguage(this.value)" class="bg-slate-800 border border-slate-600 text-xs rounded px-2 py-1 text-slate-300 outline-none focus:border-brand-primary cursor-pointer">
<!-- Options populated by JS -->
</select>

<!-- Status / Settings Info (FIXED BUTTON) -->
<button onclick="App.ui.showToast(App.i18n.t('serverManagedToast'))" class="text-slate-400 hover:text-white transition p-2 relative cursor-pointer" title="Server Managed">
<i class="fa-solid fa-server"></i>
<span class="absolute top-1 right-1 w-2 h-2 bg-green-500 rounded-full"></span>
</button>
</div>
</header>

<!-- MAIN LAYOUT -->
<div class="flex-1 flex overflow-hidden">

<!-- LEFT PANEL: Inputs -->
<div class="w-full md:w-[40%] flex flex-col bg-slate-900 border-r border-slate-700 relative">
<div class="p-5 flex flex-col gap-4 h-full overflow-y-auto">

<!-- Configuration Box -->
<div class="bg-brand-panel p-4 rounded-xl border border-slate-700 shadow-sm space-y-3">
<div class="flex justify-between items-center border-b border-slate-700 pb-2">
<h3 class="text-xs font-bold text-brand-primary uppercase flex items-center gap-2">
<i class="fa-solid fa-sliders"></i> <span data-i18n="configTitle">Configuration</span>
</h3>
</div>

<!-- Domain -->
<div>
<label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold" data-i18n="domainLabel">Domain</label>
<select id="domainSelect" class="glass-input w-full rounded px-3 py-2 text-sm cursor-pointer">
<!-- Populated by JS -->
</select>
</div>

<!-- Languages -->
<div class="grid grid-cols-2 gap-3">
<div>
<label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold" data-i18n="qLangLabel">Question Lang</label>
<select id="qLangSelect" class="glass-input w-full rounded px-3 py-2 text-xs cursor-pointer">
<!-- Populated by JS -->
</select>
</div>
<div>
<label class="block text-[10px] text-slate-400 mb-1 uppercase font-bold" data-i18n="aLangLabel">Answer Lang</label>
<select id="aLangSelect" class="glass-input w-full rounded px-3 py-2 text-xs cursor-pointer">
<!-- Populated by JS -->
</select>
</div>
</div>
</div>

<!-- Metadata Box -->
<div class="bg-brand-panel p-4 rounded-xl border border-slate-700 shadow-sm">
<h3 class="text-xs font-bold text-brand-primary uppercase mb-3 flex items-center gap-2">
<i class="fa-solid fa-tag"></i> <span data-i18n="metaTitle">Document Info</span>
</h3>
<div class="grid grid-cols-3 gap-3">
<div class="col-span-2">
<label class="block text-[10px] text-slate-400 mb-1 uppercase" data-i18n="docNameLabel">Document Name</label>
<input type="text" id="docName" class="glass-input w-full rounded px-3 py-2 text-sm font-medium" placeholder="e.g. FCOM / Policy X">
</div>
<div class="col-span-1">
<label class="block text-[10px] text-slate-400 mb-1 uppercase" data-i18n="pageNumLabel">Page Ref</label>
<input type="text" id="pageNum" class="glass-input w-full rounded px-3 py-2 text-sm font-medium text-center" placeholder="123">
</div>
</div>
</div>

<!-- Source Content Area -->
<div class="flex-1 flex flex-col min-h-[250px]">
<div class="flex justify-between items-end mb-2">
<label class="text-xs font-bold text-slate-300 uppercase flex items-center gap-2">
<i class="fa-solid fa-align-left text-brand-primary"></i> <span data-i18n="sourceTextLabel">Source Content</span>
</label>

<div class="flex items-center gap-2">
<input type="file" id="fileUpload" class="hidden" accept=".txt,.md,.csv,.json,.xml,.png,.jpg,.jpeg,.webp" onchange="App.ui.handleFileUpload(this)">
<button onclick="document.getElementById('fileUpload').click()"
class="bg-slate-700 hover:bg-slate-600 text-brand-primary hover:text-white border border-slate-600 font-bold py-2 px-4 rounded-lg shadow-md transition flex items-center gap-2 text-sm cursor-pointer">
<i class="fa-solid fa-cloud-arrow-up text-lg"></i>
<span data-i18n="uploadBtn">UPLOAD FILE</span>
</button>

<span class="w-px h-6 bg-slate-600 mx-2"></span>

<button onclick="App.ui.clearInput()" class="text-xs text-slate-500 hover:text-red-400 transition" data-i18n="clear">Clear</button>
</div>
</div>

<div class="relative flex-1 h-full">
<!-- Text Input -->
<textarea id="sourceText" oninput="App.ui.updateCharCount()"
class="glass-input w-full h-full rounded-xl p-4 text-sm font-mono leading-relaxed resize-none focus:ring-brand-primary whitespace-pre-wrap"
placeholder="Paste text here or upload a file (Text/Image)..."></textarea>

<!-- Image Preview Overlay (Hidden by default) -->
<div id="imagePreviewContainer" class="hidden absolute inset-0 bg-slate-900/90 rounded-xl flex-col items-center justify-center border-2 border-dashed border-brand-primary z-10 p-4">
<img id="previewImgElement" class="max-h-[80%] max-w-full rounded shadow-lg object-contain mb-2" />
<div class="flex gap-2">
<span class="text-xs text-brand-primary bg-brand-primary/10 px-2 py-1 rounded">Image Mode Active</span>
<button onclick="App.ui.clearInput()" class="text-xs text-red-400 hover:text-white px-2 py-1 bg-red-900/20 rounded">Remove</button>
</div>
</div>
</div>

<div class="flex justify-end mt-1">
<span id="charCount" class="text-[10px] text-slate-500">0 chars</span>
</div>
</div>

<!-- Analyze Button -->
<div class="mt-auto pt-4">
<div id="errorBox" class="hidden mb-2 p-3 bg-red-900/40 border border-red-800 rounded text-red-200 text-xs flex flex-col gap-1">
<div class="flex items-center gap-2 font-bold"><i class="fa-solid fa-triangle-exclamation"></i> <span data-i18n="error">Error</span>:</div>
<span id="errorMsg">Details...</span>
</div>

<button id="analyzeBtn" onclick="App.logic.analyzeText()" class="w-full bg-brand-primary hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex justify-center items-center gap-2 group cursor-pointer">
<span id="btnText" data-i18n="analyzeBtn">Generate Q&A</span>
<i id="btnIcon" class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition-transform"></i>
<div id="btnLoader" class="loader hidden border-white/20 border-t-white"></div>
</button>
</div>
</div>
</div>

<!-- RIGHT PANEL: Output & Log -->
<div class="w-full md:w-[60%] flex flex-col bg-[#0f172a]">

<!-- Preview Section -->
<div class="h-[55%] bg-slate-900/50 p-6 border-b border-slate-700 overflow-y-auto relative">
<div class="flex items-center justify-between mb-4">
<h2 class="text-sm font-bold text-brand-primary uppercase tracking-widest flex items-center gap-2">
<i class="fa-solid fa-robot"></i> <span data-i18n="previewTitle">AI Output Preview</span>
</h2>
<span id="statusTag" class="text-[10px] bg-slate-800 text-slate-500 px-2 py-1 rounded border border-slate-700" data-i18n="statusReady">Ready</span>
</div>

<!-- Quality Box -->
<div id="qualityBox" class="hidden mb-4 p-3 bg-slate-800/50 rounded-lg border border-slate-700 text-xs">
<div class="flex items-center justify-between mb-2">
<div class="flex items-center gap-2">
<span class="font-bold uppercase text-slate-400" data-i18n="qualityScore">Quality Score</span>
<span id="qScoreBadge" class="px-2 py-0.5 rounded text-white font-bold">0</span>
</div>
<div class="flex items-center gap-2">
<span class="font-bold uppercase text-slate-400" data-i18n="groundingStatus">Grounding</span>
<span id="groundingBadge" class="px-2 py-0.5 rounded text-white font-bold">-</span>
</div>
</div>
<ul id="qReasons" class="list-disc list-inside text-slate-400 mb-2 italic"></ul>

<details class="group">
<summary class="cursor-pointer text-brand-info hover:text-white font-semibold select-none flex items-center gap-1">
<i class="fa-solid fa-chevron-right text-[10px] group-open:rotate-90 transition"></i>
<span data-i18n="viewExtract">View Source Extract</span>
</summary>
<div class="mt-2 p-2 bg-slate-900 rounded border border-slate-700 font-mono text-[10px] text-slate-300 whitespace-pre-wrap" id="extractPreview"></div>
<div class="mt-1 text-[9px] text-slate-500 font-mono" id="citationPreview"></div>
</details>
</div>

<div class="space-y-4 pb-10">
<div>
<label class="text-[10px] font-bold text-slate-400 uppercase block mb-1" data-i18n="generatedQ">Question</label>
<textarea id="questionOutput" class="glass-input w-full rounded-lg p-3 text-white text-sm font-bold h-16" readonly></textarea>
</div>

<div class="h-40 flex flex-col">
<label class="text-[10px] font-bold text-slate-400 uppercase block mb-1" data-i18n="generatedA">Answer</label>
<textarea id="answerOutput" class="glass-input w-full flex-1 rounded-lg p-3 text-slate-300 text-sm font-mono whitespace-pre" readonly></textarea>
</div>

<div class="flex justify-end gap-3 pt-2">
<button id="regenerateBtn" onclick="App.logic.regenerate()" disabled class="text-xs text-brand-primary hover:text-white font-bold px-4 py-2 border border-brand-primary/50 hover:border-brand-primary rounded-lg transition flex items-center gap-2 opacity-50 cursor-not-allowed">
<i class="fa-solid fa-rotate"></i> <span data-i18n="regenerateBtn">Regenerate</span>
</button>
<button id="addToLogBtn" onclick="App.logic.addToLog()" disabled class="bg-slate-800 text-slate-500 font-semibold px-6 py-2 rounded-lg border border-slate-700 transition cursor-not-allowed flex items-center gap-2">
<i class="fa-solid fa-circle-plus"></i> <span data-i18n="addBtn">Add to Log</span>
</button>
</div>
</div>
</div>

<!-- Log / Export Section -->
<div class="h-[45%] flex flex-col bg-[#0f172a]">
<div class="bg-slate-900 border-b border-slate-800 px-4 py-2 shadow-md z-10 shrink-0 flex flex-col gap-2">
<div class="flex justify-between items-center">
<div class="flex items-center gap-4">
<span class="text-xs font-bold text-slate-300"><span data-i18n="logTitle">Session Log</span> (<span id="counterDisplay">0</span>)</span>
</div>
<div class="flex items-center gap-2">
<div class="flex bg-slate-800 rounded-lg p-0.5 border border-slate-700">
<button onclick="App.exporters.toExcel()" class="px-3 py-1 text-[10px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition" title="Export Excel"><i class="fa-solid fa-file-excel text-green-500 mr-1"></i> XLSX</button>
<div class="w-px bg-slate-700 my-1"></div>
<button onclick="App.exporters.toCSV()" class="px-3 py-1 text-[10px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition" title="Export CSV"><i class="fa-solid fa-file-csv text-blue-500 mr-1"></i> CSV</button>
<div class="w-px bg-slate-700 my-1"></div>
<button onclick="App.exporters.toJSON()" class="px-3 py-1 text-[10px] font-bold text-slate-300 hover:text-white hover:bg-slate-700 rounded transition" title="Export JSON"><i class="fa-solid fa-code text-yellow-500 mr-1"></i> JSON</button>
</div>
<button onclick="App.logic.clearLog()" class="text-xs text-red-400 hover:text-red-300 ml-2" title="Clear All"><i class="fa-solid fa-trash"></i></button>
</div>
</div>

<div class="flex gap-2 items-center pb-1">
<select id="filterDomain" onchange="App.logic.renderTable()" class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-1 outline-none focus:border-brand-primary cursor-pointer">
<option value="all" data-i18n="allDomains">All Domains</option>
</select>
<select id="filterStatus" onchange="App.logic.renderTable()" class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-1 outline-none focus:border-brand-primary cursor-pointer">
<option value="all" data-i18n="allStatuses">All Statuses</option>
<option value="Draft">Draft</option>
<option value="Reviewed">Reviewed</option>
<option value="Approved">Approved</option>
</select>
<input type="text" id="filterSearch" oninput="App.logic.renderTable()" placeholder="Search..." class="bg-slate-800 border border-slate-700 text-[10px] text-slate-300 rounded px-2 py-1 w-40 outline-none focus:border-brand-primary placeholder:text-slate-600">
</div>
</div>

<div class="flex-1 overflow-auto">
<table class="w-full text-left border-collapse">
<thead class="bg-slate-800 text-xs uppercase sticky top-0 z-10 shadow-sm text-slate-400">
<tr>
<th class="px-4 py-3 font-semibold border-b border-slate-700 w-12">#</th>
<th class="px-4 py-3 font-semibold border-b border-slate-700 w-24" data-i18n="thDoc">Doc</th>
<th class="px-4 py-3 font-semibold border-b border-slate-700" data-i18n="thContent">Q & A</th>
<th class="px-4 py-3 font-semibold border-b border-slate-700 w-28" data-i18n="thMeta">Meta</th>
<th class="px-4 py-3 font-semibold border-b border-slate-700 w-16"></th>
</tr>
</thead>
<tbody id="logTableBody" class="text-sm divide-y divide-slate-800/50">
<!-- Rows injected here -->
</tbody>
</table>
</div>
</div>
</div>
</div>

<!-- Notes Modal -->
<div id="notesModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
<div class="bg-slate-800 border border-slate-600 rounded-xl p-4 w-96 shadow-2xl">
<h3 class="text-sm font-bold text-white mb-2" data-i18n="reviewerNotes">Reviewer Notes</h3>
<textarea id="notesInput" class="w-full bg-slate-900 border border-slate-700 rounded p-2 text-xs text-white h-24 mb-3 resize-none focus:border-brand-primary outline-none"></textarea>
<div class="flex justify-end gap-2">
<button onclick="document.getElementById('notesModal').classList.add('hidden')" class="text-slate-400 text-xs hover:text-white px-3 py-1" data-i18n="cancel">Cancel</button>
<button onclick="App.logic.saveNotes()" class="bg-brand-primary text-white text-xs px-4 py-1 rounded hover:bg-indigo-500" data-i18n="save">Save</button>
</div>
</div>
</div>

<!-- Toast -->
<div id="toast" class="fixed bottom-5 right-5 bg-brand-success text-white px-4 py-3 rounded-lg shadow-2xl transform translate-y-24 transition duration-300 flex items-center gap-3 z-50 border border-green-400">
<i class="fa-solid fa-check-circle text-lg"></i>
<div>
<h4 class="font-bold text-sm" data-i18n="success">Success</h4>
<p class="text-xs text-green-100" id="toastMsg">Action completed.</p>
</div>
</div>

<!-- APP LOGIC -->
<script>
// WINDOWS ERROR HANDLER: Catch any load errors and alert
window.onerror = function(msg, url, line) {
alert("Startup Error: " + msg + "\nLine: " + line);
return false;
};

const App = {
api: { baseUrl: "https://askdesk-api.captsertacgul.workers.dev" },

config: {
languages: [
{code: 'en', name: 'English', label: 'English'},
{code: 'tr', name: 'Turkish', label: 'TÃ¼rkÃ§e'},
{code: 'de', name: 'German', label: 'Deutsch'},
{code: 'fr', name: 'French', label: 'FranÃ§ais'},
{code: 'es', name: 'Spanish', label: 'EspaÃ±ol'},
{code: 'pt-BR', name: 'Portuguese (BR)', label: 'PortuguÃªs'},
{code: 'ja', name: 'Japanese', label: 'æ—¥æœ¬èªž'},
{code: 'ko', name: 'Korean', label: 'í•œêµ­ì–´'},
{code: 'pl', name: 'Polish', label: 'Polski'},
{code: 'ru', name: 'Russian', label: 'Ð ÑƒÑÑÐºÐ¸Ð¹'},
{code: 'hi', name: 'Hindi', label: 'à¤¹à¤¿à¤¨à¥à¤¦à¥€'},
{code: 'it', name: 'Italian', label: 'Italiano'},
{code: 'ar', name: 'Arabic', label: 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©', dir: 'rtl'}
],
domains: [
{id: 'general', label: 'General'},
{id: 'aviation', label: 'Aviation'},
{id: 'strategy', label: 'Strategy'},
{id: 'legal', label: 'Legal'},
{id: 'medical', label: 'Medical'},
{id: 'compliance', label: 'Compliance / ISO'}
]
},

data: {
qaLog: [],
previewState: null,
editingNoteId: null,
currentImage: null
},

// --- I18N MODULE ---
i18n: {
currentLang: 'en',
translations: {
en: {
bannerWarning: "ðŸ”’ Secure Mode: API Key is managed server-side. Do not paste PII.",
serverManagedToast: "API Key managed server-side.",
appSubtitle: "PROD SERVER EDITION",
configTitle: "Configuration", domainLabel: "Domain", qLangLabel: "Question Lang", aLangLabel: "Answer Lang",
metaTitle: "Document Info", docNameLabel: "Doc Name", pageNumLabel: "Page Ref",
sourceTextLabel: "Source Content", clear: "Clear", error: "Error",
analyzeBtn: "Generate Q&A", previewTitle: "AI Output Preview", statusReady: "Ready",
generatedQ: "Question", generatedA: "Answer", addBtn: "Add to Log", regenerateBtn: "Regenerate",
logTitle: "Session Log", thDoc: "Doc", thContent: "Q & A", thMeta: "Meta",
noData: "No entries yet.", success: "Success", analyzing: "Analyzing...",
minCharsErr: "Please provide text or an image.",
notFound: "Not found in provided text",
uploadBtn: "UPLOAD FILE", uploadError: "File format not supported.",
qualityScore: "Quality Score", groundingStatus: "Grounding",
viewExtract: "View Source Extract", reviewerNotes: "Reviewer Notes",
allDomains: "All Domains", allStatuses: "All Statuses",
statusDraft: "Draft", statusReviewed: "Reviewed", statusApproved: "Approved",
cancel: "Cancel", save: "Save"
},
tr: {
bannerWarning: "ðŸ”’ GÃ¼venli Mod: API AnahtarÄ± sunucuda yÃ¶netilir. Gizli veri girmeyin.",
serverManagedToast: "API anahtarÄ± sunucuda yÃ¶netiliyor.", // FIXED COMMA HERE
appSubtitle: "PROD SUNUCU SÃœRÃœMÃœ",
configTitle: "YapÄ±landÄ±rma", domainLabel: "Alan", qLangLabel: "Soru Dili", aLangLabel: "Cevap Dili",
metaTitle: "DokÃ¼man", docNameLabel: "DokÃ¼man AdÄ±", pageNumLabel: "Sayfa",
sourceTextLabel: "Kaynak Ä°Ã§erik", clear: "Temizle", error: "Hata",
analyzeBtn: "OluÅŸtur", previewTitle: "Ã–nizleme", statusReady: "HazÄ±r",
generatedQ: "Soru", generatedA: "Cevap", addBtn: "Listeye Ekle", regenerateBtn: "Yeniden Ãœret",
logTitle: "KayÄ±tlar", thDoc: "DokÃ¼man", thContent: "Ä°Ã§erik", thMeta: "Detay",
noData: "Veri yok.", success: "BaÅŸarÄ±lÄ±", analyzing: "Ä°ÅŸleniyor...",
minCharsErr: "LÃ¼tfen metin girin veya gÃ¶rsel yÃ¼kleyin.",
notFound: "Metinde bulunamadÄ±",
uploadBtn: "DOSYA YÃœKLE", uploadError: "Format desteklenmiyor.",
qualityScore: "Kalite PuanÄ±", groundingStatus: "Dayanak",
viewExtract: "AlÄ±ntÄ±yÄ± GÃ¶ster", reviewerNotes: "Ä°nceleme NotlarÄ±",
allDomains: "TÃ¼m Alanlar", allStatuses: "TÃ¼m Durumlar",
statusDraft: "Taslak", statusReviewed: "Ä°ncelendi", statusApproved: "OnaylandÄ±",
cancel: "Ä°ptal", save: "Kaydet"
}
},

t(key) {
const lang = this.currentLang;
const dict = this.translations[lang] || this.translations['en'];
return dict[key] || this.translations['en'][key] || key;
},

updateUI() {
document.querySelectorAll('[data-i18n]').forEach(el => {
el.innerText = this.t(el.getAttribute('data-i18n'));
});
const langObj = App.config.languages.find(l => l.code === this.currentLang);
document.documentElement.dir = (langObj && langObj.dir === 'rtl') ? 'rtl' : 'ltr';
}
},

// --- STORAGE ---
storage: {
getPrefs: () => JSON.parse(localStorage.getItem('askdesk_prefs') || '{"uiLang":"en","domain":"general"}'),
savePrefs: (p) => localStorage.setItem('askdesk_prefs', JSON.stringify({...App.storage.getPrefs(), ...p}))
},

// --- PROMPT BUILDER (FINAL) ---

promptBuilder: {

  build(

    domain,

    qLang,

    aLang,

    sourceText,

    retryCount,

    hasImage,

    extra = {}

  ) {

    const {

      regenNonce = 0,

      prevQuestion = ""

    } = extra;

    const constraints =

      retryCount > 0

        ? `- STRICTER MODE (Retry ${retryCount}):

- Question MUST be unambiguous.

- Citations MUST match extract exactly.`

        : "";

    const notFoundTxt =

      App.i18n.translations[aLang]?.notFound || "Not found";

    const inputContext = hasImage

      ? `Input is an IMAGE.

- Perform OCR and visual understanding.

- Use ONLY information visible in the image.`

      : `Input is TEXT provided in payload.

- Use ONLY the provided text.`;

    const groundingRule = hasImage

      ? `- Image mode:

  - Provide extracted visible text as "extract".

  - Citations may be empty or approximate.`

      : `- Text mode (STRICT GROUNDING):

  - "extract" MUST be an exact, verbatim substring of the input text.

  - Answer MUST be derived strictly from "extract".

  - Do NOT use outside knowledge.`;

    return `

System:

You are AskDesk v2.4, a strict Questionâ€“Answer generation engine.

Domain:

${domain.toUpperCase()} ${

      domain === "aviation"

        ? "(Role: Senior Pilot. No speculation. No 'According to...')"

        : ""

    }

${inputContext}

Task:

Generate ONE JSON object with EXACT keys:

{

  "question": string,

  "answer": string,

  "extract": string,

  "citations": [{ "start": number, "end": number }],

  "quality_score": number,

  "quality_reasons": string[]

}

Instructions:

1. Generate ONE clear, specific question in ${qLang}.

2. Generate the answer in ${aLang}.

3. If ${aLang} == source language:

   - Answer MUST be an exact copy of "extract".

4. If ${aLang} != source language:

   - Answer MUST be a faithful translation of "extract".

Rules:

- If the answer is NOT found in the input:

  - answer = "${notFoundTxt}"

  - extract = ""

  - citations = []

  - quality_score = 0

- Do NOT hallucinate.

- Do NOT rephrase extract unless translating.

${groundingRule}

REGENERATION CONTROL:

- REGEN_NONCE = ${regenNonce}

- PREVIOUS_QUESTION = ${JSON.stringify(prevQuestion)}

CRITICAL:

- You MUST generate a DIFFERENT question than PREVIOUS_QUESTION.

- Pick a DIFFERENT sentence or fact from the input text.

- Do NOT repeat the same intent, wording, or focus.

${constraints}

Output:

- Return ONLY valid JSON.

- Do NOT wrap in markdown.

- Do NOT add explanations.

`.trim();

  }

}
 
 
// --- MAIN LOGIC ---
logic: {
filters: { domain: 'all', status: 'all', search: '' },

validateGrounding(source, extract, citations, answer, aLang, hasImage) {
if (hasImage) return { ok: true, reason: "Image Mode (OCR Verified)" };
if (!extract || extract.trim() === "") return { ok: true, reason: "Not Found case" };
if (!source.includes(extract)) return { ok: false, reason: "Extract not in source." };
if (!citations || citations.length === 0) return { ok: false, reason: "Missing citations." };
for (const c of citations) {
if (c.start >= 0 && c.end <= source.length) {
const snippet = source.substring(c.start, c.end);
if (snippet.trim() === extract.trim()) return { ok: true, reason: "Verified" };
}
}
return { ok: false, reason: "Indices mismatch." };
},

async analyzeText(opts = {}) {
 const {
   retryCount = 0,
   groupId: forcedGroupId = null,
   version: forcedVersion = 0,
   regenNonce = 0,
   prevQuestion = ""
 } = opts;

const hasImage = !!App.data.currentImage;
const sourceText = document.getElementById('sourceText').value.trim();

if (!hasImage && sourceText.length < 50) return App.ui.showError(App.i18n.t('minCharsErr'));

if(retryCount === 0) App.ui.setLoading(true);

const domain = document.getElementById('domainSelect').value;
const qLang = document.getElementById('qLangSelect').value;
const aLang = document.getElementById('aLangSelect').value;

try {
const promptStr = App.promptBuilder.build(
 domain, qLang, aLang, sourceText, retryCount, hasImage,
 {
   regenNonce: (forcedVersion || 0) + retryCount,
   prevQuestion: App.data.previewState?.result?.question || ""
 }
);

const payload = {
prompt: promptStr,
sourceText: hasImage ? "" : sourceText,
imageDataUrl: hasImage ? App.data.currentImage : null,
meta: { domain, qLang, aLang }
};

const response = await fetch(App.api.baseUrl + '/generate', {
method: 'POST',
headers: { 'Content-Type': 'application/json' },
body: JSON.stringify(payload)
});

if (!response.ok) {
let errText = '';
try { errText = await response.text(); } catch (_) {}
throw new Error(`Server Error: ${response.status}${errText ? " | " + errText : ""}`);
}
const res = await response.json();

const grounding = this.validateGrounding(sourceText, res.extract, res.citations, res.answer, aLang, hasImage);
const score = res.quality_score || 0;

if (!hasImage && (!grounding.ok || score < 70) && retryCount < 1) {
return this.analyzeText({ retryCount: retryCount + 1, groupId: forcedGroupId, version: forcedVersion });
}

const groupId = forcedGroupId || crypto.randomUUID();
const version = forcedGroupId ? (forcedVersion + 1) : 1;

App.data.previewState = { result: res, grounding, domain, qLang, aLang, groupId, version, hasImage };
App.ui.updatePreview(res, grounding);

} catch (e) {
App.ui.showError(e.message);
} finally {
if (retryCount === 0) App.ui.setLoading(false);
}
},

regenerate() {
 if (!App.data.previewState) return;
 const { groupId, version, result } = App.data.previewState;
 // nonce + Ã¶nceki soru
 return this.analyzeText({
   retryCount: 0,
   groupId,
   version,
   regenNonce: Date.now(),
   prevQuestion: result?.question || ""
 });
}

addToLog() {
if (!App.data.previewState) return;
const s = App.data.previewState;
const r = s.result;

const entry = {
id: crypto.randomUUID(),
groupId: s.groupId,
version: s.version,
docName: document.getElementById('docName').value || "N/A",
pageNum: document.getElementById('pageNum').value || "-",
domain: s.domain,
qLang: s.qLang, aLang: s.aLang,
question: r.question,
answer: r.answer,
extract: r.extract,
citations: r.citations,
qualityScore: r.quality_score,
groundingOk: s.grounding.ok,
status: "Draft",
reviewerNotes: s.hasImage ? "[From Image Source]" : "",
createdAtISO: new Date().toISOString(),
modelName: "gemini-2.5-flash"
};

App.data.qaLog.push(entry);
this.renderTable();
App.ui.showToast(App.i18n.t('success'));

App.ui.clearInput();
document.getElementById('questionOutput').value = '';
document.getElementById('answerOutput').value = '';
document.getElementById('qualityBox').classList.add('hidden');
document.getElementById('addToLogBtn').disabled = true;
document.getElementById('regenerateBtn').disabled = true;
App.data.previewState = null;
},

renderTable() {
const tbody = document.getElementById('logTableBody');
const f = this.filters;
f.domain = document.getElementById('filterDomain').value;
f.status = document.getElementById('filterStatus').value;
f.search = document.getElementById('filterSearch').value.toLowerCase();

const filtered = App.data.qaLog.filter(item => {
if (f.domain !== 'all' && item.domain !== f.domain) return false;
if (f.status !== 'all' && item.status !== f.status) return false;
if (f.search && !item.question.toLowerCase().includes(f.search) && !item.docName.toLowerCase().includes(f.search)) return false;
return true;
});

document.getElementById('counterDisplay').innerText = filtered.length;
tbody.innerHTML = '';

if (filtered.length === 0) {
tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-600 italic text-xs">${App.i18n.t('noData')}</td></tr>`;
return;
}

[...filtered].reverse().forEach((item) => {
const tr = document.createElement('tr');
tr.className = "hover:bg-slate-800/50 transition border-b border-slate-800/50 group";
tr.innerHTML = `
<td class="px-4 py-3 text-slate-500 font-mono text-[10px] align-top">v${item.version}</td>
<td class="px-4 py-3 align-top">
<div class="text-white text-xs font-bold truncate w-24" title="${item.docName}">${item.docName}</div>
<div class="text-brand-primary text-[10px]">p.${item.pageNum}</div>
</td>
<td class="px-4 py-3 align-top">
<div class="mb-1 text-slate-200 text-xs font-medium">${item.question}</div>
<div class="text-slate-400 text-[10px] font-mono truncate w-64" title="${item.answer}">${item.answer}</div>
<div class="mt-1 flex gap-2">
<span class="text-[9px] px-1 rounded ${item.qualityScore >= 70 ? 'bg-green-900 text-green-300' : 'bg-red-900 text-red-300'}">QS: ${item.qualityScore}</span>
${item.reviewerNotes ? `<i class="fa-solid fa-note-sticky text-yellow-500 text-[10px]" title="${item.reviewerNotes}"></i>` : ''}
</div>
</td>
<td class="px-4 py-3 align-top">
<select onchange="App.logic.updateStatus('${item.id}', this.value)" class="bg-slate-800 border border-slate-600 text-[9px] text-white rounded px-1 py-0.5 outline-none mb-1 w-full cursor-pointer">
<option value="Draft" ${item.status==='Draft'?'selected':''}>Draft</option>
<option value="Reviewed" ${item.status==='Reviewed'?'selected':''}>Review</option>
<option value="Approved" ${item.status==='Approved'?'selected':''}>Approve</option>
</select>
<button onclick="App.logic.openNotes('${item.id}')" class="text-[9px] text-brand-info hover:underline flex items-center gap-1"><i class="fa-solid fa-pen"></i> Notes</button>
</td>
<td class="px-4 py-3 align-top text-right">
<button onclick="App.logic.deleteEntry('${item.id}')" class="text-slate-600 hover:text-red-400 transition opacity-0 group-hover:opacity-100 p-2"><i class="fa-solid fa-trash"></i></button>
</td>
`;
tbody.appendChild(tr);
});
},

updateStatus(id, newStatus) {
const item = App.data.qaLog.find(x => x.id === id);
if (item) { item.status = newStatus; this.renderTable(); }
},
openNotes(id) {
App.data.editingNoteId = id;
const item = App.data.qaLog.find(x => x.id === id);
document.getElementById('notesInput').value = item.reviewerNotes || '';
document.getElementById('notesModal').classList.remove('hidden');
},
saveNotes() {
const item = App.data.qaLog.find(x => x.id === App.data.editingNoteId);
if (item) { item.reviewerNotes = document.getElementById('notesInput').value; this.renderTable(); }
document.getElementById('notesModal').classList.add('hidden');
},
deleteEntry(id) { App.data.qaLog = App.data.qaLog.filter(x => x.id !== id); this.renderTable(); },
clearLog() { if (confirm('Clear?')) { App.data.qaLog = []; this.renderTable(); } }
},

// --- UI MODULE ---
ui: {
init() {
try {
const domSelect = document.getElementById('domainSelect');
const domFilter = document.getElementById('filterDomain');
domSelect.innerHTML = '';
App.config.domains.forEach(d => {
domSelect.add(new Option(d.label, d.id));
domFilter.add(new Option(d.label, d.id));
});
['qLangSelect', 'aLangSelect', 'uiLangSelect'].forEach(id => {
const el = document.getElementById(id);
el.innerHTML = '';
App.config.languages.forEach(l => el.add(new Option(l.label, l.code)));
});
const prefs = App.storage.getPrefs();
document.getElementById('uiLangSelect').value = prefs.uiLang;
document.getElementById('domainSelect').value = prefs.domain || 'general';
this.changeLanguage(prefs.uiLang);
} catch(e) {
alert("Initialization Error: " + e.message);
}
},

changeLanguage(code) {
App.i18n.currentLang = code;
App.i18n.updateUI();
App.storage.savePrefs({ uiLang: code });
},

toggleSettings: () => {},
updateCharCount() {
const len = document.getElementById('sourceText').value.length;
document.getElementById('charCount').innerText = `${len} chars`;
},

clearInput() {
document.getElementById('sourceText').value = '';
document.getElementById('sourceText').classList.remove('hidden');
document.getElementById('imagePreviewContainer').classList.add('hidden');
App.data.currentImage = null;
this.updateCharCount();
},

handleFileUpload(input) {
const file = input.files[0];
if (!file) return;

if (file.type.startsWith('image/')) {
const reader = new FileReader();
reader.onload = (e) => {
App.data.currentImage = e.target.result;
const img = document.getElementById('previewImgElement');
img.src = e.target.result;
document.getElementById('sourceText').classList.add('hidden');
document.getElementById('imagePreviewContainer').classList.remove('hidden');
document.getElementById('imagePreviewContainer').classList.add('flex');
App.ui.showToast("Image loaded. Text mode disabled.");
};
reader.readAsDataURL(file);
} else {
const reader = new FileReader();
reader.onload = (e) => {
document.getElementById('sourceText').value = e.target.result;
App.ui.updateCharCount();
App.ui.showToast("Text file loaded (UTF-8).");
};
reader.readAsText(file, "UTF-8");
}
input.value = '';
},

setLoading(isLoading) {
const btn = document.getElementById('analyzeBtn');
btn.disabled = isLoading;
if(isLoading) { document.getElementById('btnIcon').classList.add('hidden'); document.getElementById('btnLoader').classList.remove('hidden'); }
else { document.getElementById('btnIcon').classList.remove('hidden'); document.getElementById('btnLoader').classList.add('hidden'); }
},

updatePreview(res, grounding) {
document.getElementById('questionOutput').value = res.question;
document.getElementById('answerOutput').value = res.answer;
document.getElementById('qualityBox').classList.remove('hidden');

const badge = document.getElementById('qScoreBadge');
badge.innerText = res.quality_score;
badge.className = `px-2 py-0.5 rounded text-white font-bold ${res.quality_score >= 70 ? 'bg-green-600' : 'bg-red-600'}`;

const gBadge = document.getElementById('groundingBadge');
gBadge.innerText = grounding.ok ? "Pass âœ…" : "Fail âŒ";
gBadge.className = `px-2 py-0.5 rounded text-white font-bold ${grounding.ok ? 'bg-brand-success' : 'bg-brand-accent'}`;

const rList = document.getElementById('qReasons');
rList.innerHTML = (res.quality_reasons || []).map(r => `<li>${r}</li>`).join('');
if (!grounding.ok) rList.innerHTML += `<li class="text-red-400 font-bold">${grounding.reason}</li>`;

document.getElementById('extractPreview').innerText = res.extract || "(No extract)";
document.getElementById('citationPreview').innerText = res.citations?.[0] ? `Offset: ${res.citations[0].start}-${res.citations[0].end}` : "-";

this.enableAddButton(true);
const regenBtn = document.getElementById('regenerateBtn');
regenBtn.disabled = false;
regenBtn.classList.remove('opacity-50', 'cursor-not-allowed');
},

enableAddButton(enable) {
const btn = document.getElementById('addToLogBtn');
btn.disabled = !enable;
if(enable) {
btn.classList.replace('bg-slate-800','bg-brand-success');
btn.classList.replace('text-slate-500','text-white');
btn.classList.remove('cursor-not-allowed');
} else {
btn.classList.replace('bg-brand-success','bg-slate-800');
btn.classList.replace('text-white','text-slate-500');
btn.classList.add('cursor-not-allowed');
}
},

showError: (msg) => {
const box = document.getElementById('errorBox');
document.getElementById('errorMsg').innerText = msg;
box.classList.remove('hidden');
setTimeout(() => box.classList.add('hidden'), 5000);
},
showToast: (msg) => {
const t = document.getElementById('toast');
document.getElementById('toastMsg').innerText = msg;
t.classList.remove('translate-y-24');
setTimeout(() => t.classList.add('translate-y-24'), 3000);
}
},

// --- EXPORTERS ---
exporters: {
sanitize: (v) => (typeof v === 'string' && ['=','+','-','@'].includes(v[0]) ? "'" + v : v),
getDataForExport() {
return App.data.qaLog.map(i => ({
ID: i.id, GroupID: i.groupId, Version: i.version,
Doc: this.sanitize(i.docName), Page: this.sanitize(i.pageNum),
Domain: i.domain, QLang: i.qLang, ALang: i.aLang,
Question: this.sanitize(i.question), Answer: this.sanitize(i.answer),
Quality: i.qualityScore, Grounded: i.groundingOk,
Status: i.status, Notes: this.sanitize(i.reviewerNotes),
Created: i.createdAtISO
}));
},
toExcel() {
if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
const ws = XLSX.utils.json_to_sheet(this.getDataForExport());
const wb = XLSX.utils.book_new();
XLSX.utils.book_append_sheet(wb, ws, "QA Data");
XLSX.writeFile(wb, `AskDesk_v2.4_${new Date().toISOString().slice(0,10)}.xlsx`);
},
toCSV() {
if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
const data = this.getDataForExport();
const headers = Object.keys(data[0]).join(',');
const rows = data.map(row => Object.values(row).map(v => `"${String(v || '').replace(/"/g,'""')}"`).join(','));
const csv = "\uFEFF" + [headers, ...rows].join('\n');
const a = document.createElement('a');
a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv;charset=utf-8;'}));
a.download = `AskDesk_v2.4.csv`;
a.click();
},
toJSON() {
if(!App.data.qaLog.length) return App.ui.showError(App.i18n.t('noData'));
const a = document.createElement('a');
a.href = URL.createObjectURL(new Blob([JSON.stringify(App.data.qaLog,null,2)], {type: 'application/json'}));
a.download = `AskDesk_v2.4.json`;
a.click();
}
}
};

document.addEventListener('DOMContentLoaded', () => App.ui.init());
</script>
</body>

</html>



