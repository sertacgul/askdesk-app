<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AskDesk | askdesk.app</title>
    
    <!-- UI Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Data Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#0f172a',      
                            panel: '#1e293b',     
                            primary: '#6366f1',
                            accent: '#f43f5e',
                            success: '#10b981',
                            warning: '#f59e0b',
                            info: '#3b82f6',
                            pro: '#22c55e',       
                            enterprise: '#a855f7' 
                        }
                    }
                }
            }
        }
        // PDF.js Worker Configuration
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <style>
        body { 
            background-color: #0f172a; 
            color: #e2e8f0; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            transition: all 0.3s; 
            display: flex; 
            flex-direction: column; 
            min-height: 100vh;
            overflow-y: auto; 
        }
        .glass-input { 
            background: #1e293b; 
            border: 1px solid #334155; 
            color: white; 
            transition: all 0.2s;
        }
        .glass-input:focus { 
            border-color: #6366f1; 
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2); 
            outline: none; 
        }
        option { background-color: #1e293b; color: white; padding: 5px; }
        select { cursor: pointer; }
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%; background: #6366f1; cursor: pointer; margin-top: -6px; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #334155; border-radius: 2px; }
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 5px; border: 2px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .loader {
            border: 3px solid #1e293b;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            width: 20px; height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .protected-text {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>
</head>
<body class="text-slate-200">

    <!-- HEADER -->
    <header class="bg-brand-panel border-b border-slate-700 h-auto min-h-[4rem] py-2 flex flex-wrap items-center justify-between px-4 md:px-6 shadow-lg z-20 shrink-0 gap-2 sticky top-0">
        <div class="flex items-center gap-3">
            <div class="relative w-8 h-8 md:w-10 md:h-10 group cursor-pointer">
                <!-- SVG Icon -->
                <svg viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg" class="w-full h-full drop-shadow-lg transform transition group-hover:scale-105 duration-300">
                    <rect width="40" height="40" rx="10" fill="url(#brand_gradient)"/>
                    <path d="M20 8C13.3726 8 8 13.3726 8 20C8 26.6274 13.3726 32 20 32C26.6274 32 32 26.6274 32 20C32 13.3726 26.6274 8 20 8ZM20 10.4C25.3019 10.4 29.6 14.6981 29.6 20C29.6 25.3019 25.3019 29.6 20 29.6C14.6981 29.6 10.4 25.3019 10.4 20C10.4 14.6981 14.6981 10.4 20 10.4Z" fill="white" fill-opacity="0.1"/>
                    <path d="M20 6V12M20 28V34M6 20H12M28 20H34" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    <circle cx="20" cy="20" r="5" stroke="white" stroke-width="2"/>
                    <circle cx="20" cy="20" r="2" fill="#F43F5E"/>
                    <defs>
                        <linearGradient id="brand_gradient" x1="0" y1="0" x2="40" y2="40" gradientUnits="userSpaceOnUse">
                            <stop stop-color="#6366F1"/>
                            <stop offset="1" stop-color="#8B5CF6"/>
                        </linearGradient>
                    </defs>
                </svg>
            </div>
            <div>
                <h1 class="text-lg md:text-xl font-bold text-white tracking-wide">AskDesk</h1>
                <p class="text-[9px] md:text-[10px] text-slate-400 font-mono tracking-wider">PROD v2.9.45</p>
            </div>
        </div>

        <div class="flex items-center gap-2 md:gap-2 ml-auto">
            <!-- User Email (Dynamic) -->
            <div id="userEmailDisplay" class="hidden md:block text-[10px] text-slate-400 mr-2 font-mono"></div>
            
            <!-- Usage Badge (Dynamic) -->
            <div id="usageBadge" class="h-8 px-3 rounded bg-slate-800 border border-slate-600 flex items-center justify-center text-[10px] text-slate-400 font-mono min-w-[3rem]">0/5</div>
            
            <!-- Plan Badge (Clickable for Upgrade) -->
            <button id="planBadge" class="h-8 px-3 text-[10px] font-bold rounded bg-slate-700 text-slate-300 uppercase tracking-wide border border-slate-600 transition-colors cursor-pointer flex items-center justify-center min-w-[4rem]" onclick="App.billing.upgradeRedirect()">Starter</button>
            
            <!-- Settings Trigger -->
            <button onclick="App.ui.toggleSettings()" class="h-8 w-8 rounded bg-slate-800 border border-slate-600 flex items-center justify-center text-slate-400 hover:text-white transition" title="User Account">
                <i class="fa-solid fa-user-gear"></i>
            </button>
        </div>
    </header>

    <!-- SETTINGS PANEL (User Email & Magic Link) -->
    <div id="settingsPanel" class="hidden absolute top-16 right-4 w-80 md:w-96 bg-slate-800 border border-slate-600 shadow-2xl z-50 p-4 rounded-xl">
        <h3 class="text-sm font-bold text-white mb-2 flex items-center gap-2">
            <i class="fa-solid fa-user-shield text-brand-primary"></i> <span>User Account</span>
        </h3>
        <p class="text-[10px] text-slate-400 mb-3 leading-relaxed">
            Enter your email to sync your plan and limits. We will send a <b>Magic Link</b> to login.
        </p>
        <input type="email" id="userEmailInput" class="w-full bg-slate-900 border border-slate-600 rounded p-2 text-white text-xs font-mono mb-3 focus:border-brand-primary outline-none" placeholder="user@example.com">
        
        <div class="flex justify-end gap-2">
            <button onclick="App.ui.toggleSettings()" class="text-slate-400 hover:text-white text-xs px-3 py-1">Close</button>
            <button onclick="App.auth.sendMagicLink()" class="bg-brand-primary hover:bg-indigo-500 text-white px-4 py-1.5 rounded text-xs font-bold transition">Send Magic Link</button>
        </div>
        <div id="authMessage" class="text-[10px] text-center mt-2 hidden text-slate-400">Processing...</div>
    </div>

    <!-- MAIN -->
    <div class="flex flex-col md:flex-row min-h-[calc(100vh-4rem)]">
        
        <!-- LEFT: INPUTS -->
        <div class="w-full md:w-[40%] flex flex-col bg-slate-900 border-b md:border-b-0 md:border-r border-slate-700 relative">
            
            <!-- Scrollable Content Area -->
            <div class="flex-1 p-4 flex flex-col gap-3 overflow-y-auto">
                <!-- Config -->
                <div class="bg-brand-panel p-3 rounded-xl border border-slate-700 shadow-sm space-y-2 shrink-0">
                    <div class="flex justify-between items-center border-b border-slate-700 pb-1">
                        <h3 class="text-xs font-bold text-brand-primary uppercase flex items-center gap-2">
                            <i class="fa-solid fa-sliders"></i> <span>Configuration</span>
                        </h3>
                    </div>
                    
                    <div>
                        <label class="block text-[10px] text-slate-400 mb-0.5 uppercase font-bold">Domain</label>
                        <select id="domainSelect" class="glass-input w-full rounded px-2 py-1.5 text-xs cursor-pointer"></select>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-0.5 uppercase font-bold">Question Lang</label>
                            <select id="qLangSelect" class="glass-input w-full rounded px-2 py-1.5 text-xs cursor-pointer"></select>
                        </div>
                        <div>
                            <label class="block text-[10px] text-slate-400 mb-0.5 uppercase font-bold">Answer Lang</label>
                            <select id="aLangSelect" class="glass-input w-full rounded px-2 py-1.5 text-xs cursor-pointer"></select>
                        </div>
                    </div>
                </div>

                <!-- Source Input -->
                <div class="flex-1 flex flex-col min-h-[500px]"> 
                    <div class="flex items-center gap-2 mb-1">
                        <label class="text-[10px] font-bold text-slate-300 uppercase flex items-center gap-1 shrink-0">
                            <i class="fa-solid fa-align-left text-brand-primary"></i> <span>Source</span>
                        </label>
                        
                        <div class="flex-1"></div>

                        <input type="file" id="fileUpload" class="hidden" accept=".txt,.md,.csv,.json,.xml,.png,.jpg,.jpeg,.webp,.pdf,.docx,.xlsx" onchange="App.ui.handleFileUpload(this)">
                        
                        <button onclick="document.getElementById('fileUpload').click()" 
                            class="bg-slate-700 hover:bg-slate-600 text-brand-primary hover:text-white border border-slate-600 font-bold py-1 px-3 rounded shadow-md transition flex items-center gap-1 text-[10px] h-6 cursor-pointer">
                            <i class="fa-solid fa-cloud-arrow-up text-sm"></i> 
                            <span>UPLOAD</span>
                        </button>
                        
                        <button onclick="App.ui.clearInput()" class="bg-slate-800 hover:bg-red-900/30 text-slate-400 hover:text-red-400 border border-slate-700 font-bold py-1 px-3 rounded shadow-md transition flex items-center gap-1 text-[10px] h-6 cursor-pointer">
                            <i class="fa-solid fa-eraser"></i>
                            <span>CLEAR</span>
                        </button>
                    </div>

                    <div class="relative w-full flex-1">
                        <textarea id="sourceText"
                            class="glass-input w-full h-[500px] rounded-xl p-3 text-xs font-mono leading-relaxed resize-none focus:ring-brand-primary whitespace-pre-wrap"
                            placeholder="Paste text here... (Long text enables Multi-Q option)"></textarea>
                        
                        <div id="imagePreviewContainer" class="hidden absolute inset-0 bg-slate-900/90 rounded-xl flex-col items-center justify-center border-2 border-dashed border-brand-primary z-10 p-4">
                            <img id="previewImgElement" class="max-h-[80%] max-w-full rounded shadow-lg object-contain mb-2" />
                            <div class="flex gap-2">
                                <span class="text-xs text-brand-primary bg-brand-primary/10 px-2 py-1 rounded">Image Mode Active</span>
                                <button onclick="App.ui.clearInput()" class="text-xs text-red-400 hover:text-white px-2 py-1 bg-red-900/20 rounded">Remove</button>
                            </div>
                        </div>

                        <div id="fileLoader" class="hidden absolute inset-0 bg-slate-900/80 z-20 flex-col items-center justify-center rounded-xl backdrop-blur-sm">
                            <div class="loader mb-2"></div>
                            <span class="text-xs text-brand-primary font-bold">Processing File...</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sticky Generate Button -->
            <div class="p-4 bg-slate-900 border-t border-slate-800 sticky bottom-0 z-20 shadow-[0_-5px_15px_rgba(0,0,0,0.5)]">
                <div id="errorBox" class="hidden mb-2 p-3 bg-red-900/40 border border-red-800 rounded text-red-200 text-xs flex flex-col gap-1 w-full relative">
                    <div class="flex items-center justify-between font-bold">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation"></i> <span>Limit Reached</span></div>
                        <button onclick="document.getElementById('errorBox').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    <span id="errorMsg">Daily limit reached. Upgrade to Pro.</span>
                    <a href="javascript:void(0)" onclick="App.billing.upgradeRedirect()" class="text-xs underline text-white font-bold mt-1 block">UPGRADE NOW &rarr;</a>
                </div>
                
                <button id="analyzeBtn" onclick="App.logic.startGeneration()" class="w-full bg-brand-primary hover:bg-indigo-500 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex justify-center items-center gap-2 group cursor-pointer relative overflow-hidden disabled:opacity-50 disabled:cursor-not-allowed">
                    <span id="btnText" class="text-sm md:text-base">Generate Q&A</span>
                    <i id="btnIcon" class="fa-solid fa-wand-magic-sparkles group-hover:rotate-12 transition-transform"></i>
                    <div id="btnLoader" class="loader hidden border-white/20 border-t-white"></div>
                </button>
            </div>
        </div>

        <!-- RIGHT: OUTPUT -->
        <div class="w-full md:w-[60%] flex flex-col bg-[#0f172a]">
            <!-- Preview -->
            <div class="h-[40%] bg-slate-900/50 p-4 md:p-6 border-b border-slate-700 overflow-y-auto relative">
                <div class="flex items-center justify-between mb-3">
                    <h2 class="text-xs md:text-sm font-bold text-brand-primary uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-check"></i> <span>AI Output Preview</span>
                        <a href="https://api.askdesk.app/billing/upgrade?plan=pro" target="_blank" id="previewUpgradeBtn" class="hidden ml-2 text-[9px] bg-brand-pro text-white px-2 py-0.5 rounded hover:bg-green-600 transition">UPGRADE</a>
                    </h2>
                    <span id="statusTag" class="text-[9px] bg-slate-800 text-slate-500 px-2 py-1 rounded border border-slate-700">Ready</span>
                </div>

                <div class="space-y-3 pb-8">
                    <div>
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-0.5">Question</label>
                        <textarea id="questionOutput" class="glass-input w-full rounded-lg p-3 text-white text-xs md:text-sm font-bold h-14 md:h-16 protected-text" readonly></textarea>
                    </div>
                    <div class="h-32 md:h-40 flex flex-col">
                        <label class="text-[10px] font-bold text-slate-400 uppercase block mb-0.5">Answer</label>
                        <textarea id="answerOutput" class="glass-input w-full flex-1 rounded-lg p-3 text-slate-300 text-xs md:text-sm font-mono whitespace-pre protected-text" readonly></textarea>
                    </div>
                    
                    <!-- Extract & Reasons -->
                     <details class="group mt-2">
                        <summary class="cursor-pointer text-brand-info hover:text-white font-semibold select-none flex items-center gap-1 text-[10px]">
                            <i class="fa-solid fa-chevron-right text-[9px] group-open:rotate-90 transition"></i>
                            <span>View Source Extract & Logic</span>
                        </summary>
                        <div class="mt-1 p-2 bg-slate-900 rounded border border-slate-700 font-mono text-[9px] text-slate-300 whitespace-pre-wrap" id="extractPreview"></div>
                    </details>
                </div>
            </div>

            <!-- Log Table -->
            <div class="flex-1 flex flex-col bg-[#0f172a] overflow-hidden">
                <div class="bg-slate-900 border-b border-slate-800 px-4 py-2 shadow-md z-10 shrink-0 flex flex-col gap-2">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-300">Session Log</span>
                        </div>
                    </div>
                </div>
                <div class="flex-1 overflow-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-800 text-xs uppercase sticky top-0 z-10 shadow-sm text-slate-400">
                            <tr>
                                <th class="px-4 py-3 font-semibold border-b border-slate-700 w-24">Q & A</th>
                            </tr>
                        </thead>
                        <tbody id="logTableBody" class="text-sm divide-y divide-slate-800/50"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-5 right-5 bg-brand-success text-white px-4 py-3 rounded-lg shadow-2xl transform translate-y-24 transition duration-300 flex items-center gap-3 z-50 border border-green-400">
        <i class="fa-solid fa-check-circle text-lg"></i>
        <div>
            <h4 class="font-bold text-sm">Success</h4>
            <p class="text-xs text-green-100" id="toastMsg">Action completed.</p>
        </div>
    </div>

    <!-- APP LOGIC -->
    <script>
    const App = {
        api: { 
            base: "https://api.askdesk.app",
            billing: "https://api.askdesk.app/billing"
        },
        
        config: {
            languages: [
                {code: 'en', label: 'English'}, {code: 'tr', label: 'Türkçe'}, {code: 'de', label: 'Deutsch'},
                {code: 'fr', label: 'Français'}, {code: 'es', label: 'Español'},
                {code: 'ja', label: '日本語'}, {code: 'ko', label: '한국어'},
                {code: 'ru', label: 'Русский'}, {code: 'ar', label: 'العربية'}
            ],
            domains: [
                {id: 'general', label: 'General'}, {id: 'aviation', label: 'Aviation'}, {id: 'strategy', label: 'Strategy'},
                {id: 'legal', label: 'Legal'}, {id: 'medical', label: 'Medical'}, {id: 'compliance', label: 'Compliance / ISO'}
            ]
        },

        state: {
            userEmail: localStorage.getItem('askdesk_user_email') || null,
            plan: 'Starter', // Default UI state, real state comes from API 402
            limit: 5,
            usage: 0
        },

        init: function() {
            this.checkUrlToken();
            this.ui.initDropdowns();
            this.ui.updateAuthUI();
            
            // On load, we assume free state. Backend enforces rules.
            this.ui.updateBadge("Starter");
        },

        checkUrlToken: async function() {
            const params = new URLSearchParams(window.location.search);
            const token = params.get('token');
            if (token) {
                try {
                    const res = await fetch(`${this.api.base}/auth/verify?token=${token}`);
                    const data = await res.json();
                    if (data.ok && data.email) {
                        localStorage.setItem('askdesk_user_email', data.email);
                        this.state.userEmail = data.email;
                        window.history.replaceState({}, document.title, "/");
                        this.ui.showToast("Giriş Başarılı: " + data.email);
                        this.ui.updateAuthUI();
                    }
                } catch (e) {
                    console.error("Auth Verify Error", e);
                }
            }
        },

        auth: {
            sendMagicLink: async function() {
                const email = document.getElementById('userEmailInput').value.trim();
                if (!email) return;
                
                document.getElementById('authMessage').classList.remove('hidden');
                document.getElementById('authMessage').innerText = "Sending...";

                try {
                    const res = await fetch(`${App.api.base}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email: email })
                    });
                    
                    if (res.ok) {
                        App.ui.showToast("Mail adresinize giriş linki gönderildi.");
                        setTimeout(() => App.ui.toggleSettings(), 1500);
                        document.getElementById('userEmailInput').value = "";
                    } else {
                        throw new Error("Failed");
                    }
                } catch (e) {
                    alert("Connection error. Check backend.");
                }
                document.getElementById('authMessage').classList.add('hidden');
            }
        },

        billing: {
            upgradeRedirect: function() {
                // If current user is unknown (guest/starter), upsell Pro
                const plan = "pro"; 
                if(confirm("Güvenli ödeme sayfasına (LemonSqueezy) yönlendiriliyorsunuz. Devam et?")) {
                    window.open(`${App.api.billing}/upgrade?plan=${plan}`, '_blank');
                }
            },
            cyclePlan: function() {
                this.upgradeRedirect(); 
            }
        },

        logic: {
            startGeneration: async function() {
                const promptText = document.getElementById('sourceText').value.trim();
                if (promptText.length < 10) return alert("Please enter text.");

                App.ui.setLoading(true);
                const userId = App.state.userEmail || "guest";
                
                try {
                    const payload = {
                        prompt: promptText,
                        meta: {
                            domain: document.getElementById('domainSelect').value,
                            qLang: document.getElementById('qLangSelect').value,
                            aLang: document.getElementById('aLangSelect').value
                        }
                    };

                    const res = await fetch(`${App.api.base}/generate`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-AskDesk-User': userId
                        },
                        body: JSON.stringify(payload)
                    });

                    if (res.status === 402) {
                        // LIMIT REACHED
                        document.getElementById('errorBox').classList.remove('hidden');
                        document.getElementById('previewUpgradeBtn').classList.remove('hidden');
                        App.ui.showToast("Limit doldu! Lütfen yükseltin.");
                        return;
                    }

                    if (!res.ok) throw new Error("API Error");

                    const data = await res.json();
                    
                    // Success - Update UI
                    document.getElementById('questionOutput').value = data.question || "";
                    document.getElementById('answerOutput').value = data.answer || "";
                    document.getElementById('extractPreview').innerText = data.extract || "No extract";
                    document.getElementById('errorBox').classList.add('hidden');
                    
                    // Log
                    this.addLog(data);

                    // Optimistic update of usage counter
                    let current = parseInt(document.getElementById('usageBadge').innerText.split('/')[0]) || 0;
                    App.ui.updateUsage(current + 1);

                    // If response contains plan info, update UI (optional backend feature)
                    if (data.plan) App.ui.updateBadge(data.plan);

                } catch (e) {
                    console.error(e);
                    alert("Error generating content. Check console.");
                } finally {
                    App.ui.setLoading(false);
                }
            },
            addLog: function(data) {
                const tbody = document.getElementById('logTableBody');
                const row = document.createElement('tr');
                row.className = "border-b border-slate-700 hover:bg-slate-800/50";
                row.innerHTML = `<td class="p-3 text-xs text-slate-300">
                    <div class="font-bold text-white mb-1">${data.question || '-'}</div>
                    ${data.answer ? data.answer.substring(0,80)+'...' : '-'}
                </td>`;
                tbody.prepend(row);
            }
        },

        ui: {
            initDropdowns: function() {
                const dSelect = document.getElementById('domainSelect');
                if(dSelect) {
                    dSelect.innerHTML = '';
                    App.config.domains.forEach(d => dSelect.add(new Option(d.label, d.id)));
                }
                
                ['qLangSelect', 'aLangSelect'].forEach(id => {
                    const el = document.getElementById(id);
                    if(el) {
                        el.innerHTML = '';
                        App.config.languages.forEach(l => el.add(new Option(l.label, l.code)));
                    }
                });
            },
            toggleSettings: function() {
                document.getElementById('settingsPanel').classList.toggle('hidden');
            },
            handleFileUpload: function(input) {
                const file = input.files[0];
                if (!file) return;

                const reader = new FileReader();
                const name = file.name.toLowerCase();

                document.getElementById('fileLoader').classList.remove('hidden');

                if (name.endsWith('.pdf')) {
                     reader.onload = async function(e) {
                        try {
                            const typedarray = new Uint8Array(e.target.result);
                            const pdf = await pdfjsLib.getDocument(typedarray).promise;
                            let fullText = "";
                            for(let i=1; i<=pdf.numPages; i++) {
                                const page = await pdf.getPage(i);
                                const textContent = await page.getTextContent();
                                const pageText = textContent.items.map(item => item.str).join('\n');
                                fullText += pageText + "\n\n";
                            }
                            document.getElementById('sourceText').value = fullText;
                        } catch (err) { alert("PDF Error"); }
                        document.getElementById('fileLoader').classList.add('hidden');
                    };
                    reader.readAsArrayBuffer(file);
                } 
                else if (name.endsWith('.docx')) {
                     reader.onload = function(e) {
                        mammoth.extractRawText({arrayBuffer: e.target.result})
                            .then(function(result){
                                document.getElementById('sourceText').value = result.value;
                                document.getElementById('fileLoader').classList.add('hidden');
                            })
                            .catch(function(err){ console.log(err); document.getElementById('fileLoader').classList.add('hidden'); });
                    };
                    reader.readAsArrayBuffer(file);
                }
                else if (name.endsWith('.xlsx')) {
                    reader.onload = function(e) {
                        const wb = XLSX.read(e.target.result, {type:'array'});
                        const ws = wb.Sheets[wb.SheetNames[0]];
                        const csv = XLSX.utils.sheet_to_csv(ws);
                        document.getElementById('sourceText').value = csv;
                        document.getElementById('fileLoader').classList.add('hidden');
                    };
                    reader.readAsArrayBuffer(file);
                }
                else {
                    reader.onload = function(e) {
                        document.getElementById('sourceText').value = e.target.result;
                        document.getElementById('fileLoader').classList.add('hidden');
                    };
                    reader.readAsText(file);
                }
                input.value = '';
            },
            clearInput: function() {
                document.getElementById('sourceText').value = "";
            },
            setLoading: function(loading) {
                const btn = document.getElementById('analyzeBtn');
                btn.disabled = loading;
                document.getElementById('btnLoader').classList.toggle('hidden', !loading);
                document.getElementById('btnIcon').classList.toggle('hidden', loading);
            },
            showToast: function(msg) {
                const t = document.getElementById('toast');
                t.querySelector('p').innerText = msg;
                t.classList.remove('translate-y-24');
                setTimeout(() => t.classList.add('translate-y-24'), 3000);
            },
            updateAuthUI: function() {
                const email = App.state.userEmail;
                const display = document.getElementById('userEmailDisplay');
                if (display && email) {
                    display.innerText = email;
                    display.classList.remove('hidden');
                }
            },
            updateBadge: function(text) {
                // Capitalize first letter
                if(text) document.getElementById('planBadge').innerText = text.charAt(0).toUpperCase() + text.slice(1);
            },
            updateUsage: function(curr) {
                // We show current usage. Max is backend determined, so we just show what we count.
                // Or if we know the plan limits: Starter 5, Pro 100
                // For simplicity, just showing usage count.
                const plan = document.getElementById('planBadge').innerText.toLowerCase();
                const limit = plan === 'pro' ? 100 : (plan === 'enterprise' ? 1000 : 5);
                document.getElementById('usageBadge').innerText = curr + " / " + limit;
            }
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
